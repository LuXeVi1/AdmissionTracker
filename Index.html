<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Tracker + AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c084fc;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a855f7;
        }

        .dashed-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='8' ry='8' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s ease;
        }

        .dashed-box:hover {
            background-color: #F8FAFC;
            border-color: #94A3B8;
        }

        .swal2-popup {
            font-family: 'Sarabun', sans-serif;
            border-radius: 15px;
        }

        /* --- New Typography Styles for AI Output --- */
        .prose-custom h1,
        .prose-custom h2,
        .prose-custom h3 {
            color: #4338ca;
            /* Indigo-700 */
            font-weight: 700;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
        }

        .prose-custom h3 {
            font-size: 1.1em;
            border-left: 4px solid #facc15;
            padding-left: 8px;
        }

        .prose-custom p {
            margin-bottom: 1em;
            line-height: 1.7;
            color: #374151;
        }

        .prose-custom ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose-custom ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose-custom li {
            margin-bottom: 0.5em;
        }

        .prose-custom strong {
            color: #7e22ce;
            font-weight: 700;
        }

        /* Purple emphasis */
        .prose-custom blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 1em;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-2 md:p-6">

    <!-- Navbar -->
    <div
        class="max-w-7xl mx-auto bg-blue-600 text-white p-4 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-white/20 p-2 rounded-full"><i class="fas fa-user-graduate text-2xl"></i></div>
            <div>
                <h1 class="text-xl md:text-2xl font-bold">Admission Tracker</h1>
                <p class="text-blue-100 text-sm">GPAX: <span id="displayGpax"
                        class="font-bold text-yellow-300">-.-</span></p>
            </div>
        </div>
        <div class="mt-3 md:mt-0 text-right flex flex-col items-end">
            <div class="flex items-center gap-2 bg-blue-700 px-3 py-1 rounded-lg">
                <i class="fas fa-bullseye text-yellow-400"></i>
                <span class="text-sm font-semibold">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <span id="headerTargetCount">5</span> ‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢</span>
                <span id="uniCountBadge"
                    class="bg-white text-blue-700 text-xs font-bold px-2 py-0.5 rounded-full ml-1">0/5</span>
            </div>
            <div class="flex gap-2 mt-2">
                <button onclick="openBudgetPlanner()"
                    class="bg-white/10 hover:bg-white/20 border border-white/20 text-white text-sm font-medium px-4 py-1.5 rounded-lg transition flex items-center gap-2 shadow-sm backdrop-blur-sm group">
                    <i class="fas fa-coins text-yellow-300 group-hover:scale-110 transition"></i> ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
                </button>
                <button onclick="openSettings()"
                    class="bg-black/20 hover:bg-black/30 border border-transparent text-blue-100 text-sm font-medium px-4 py-1.5 rounded-lg transition flex items-center gap-2 shadow-sm">
                    <i class="fas fa-cog group-hover:rotate-90 transition"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 items-start h-full">

        <!-- ================= LEFT COLUMN: AI ASSISTANT ================= -->
        <div
            class="bg-white rounded-xl shadow-md border border-purple-100 overflow-hidden flex flex-col lg:sticky lg:top-4">
            <div
                class="bg-gradient-to-r from-purple-100 to-indigo-50 p-4 border-b border-purple-200 flex items-center gap-2">
                <i class="fas fa-robot text-purple-600 text-xl"></i>
                <div>
                    <h2 class="font-bold text-purple-800">AI Assistant</h2>
                    <p class="text-xs text-purple-600">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å & ‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
                </div>
            </div>

            <div class="p-4 space-y-6 flex-grow overflow-y-auto custom-scrollbar"
                style="max-height: calc(100vh - 150px);">

                <!-- Feature 1: Question Generator -->
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-100 shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm flex items-center">
                        <i class="fas fa-comment-dots text-purple-500 mr-2"></i>1. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠?
                    </h3>

                    <textarea id="situationInput" rows="2"
                        class="w-full p-3 border border-purple-200 rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-400 shadow-sm"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÅ‡∏ï‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏π..."></textarea>

                    <!-- Quick Chips -->
                    <div class="flex flex-wrap gap-2 mt-2 mb-3">
                        <button onclick="setSituation('‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° ‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡∏û‡∏≠‡∏£‡πå‡∏ï')"
                            class="text-xs bg-white border border-purple-200 text-purple-600 px-2 py-1 rounded-full hover:bg-purple-100 transition shadow-sm">üéÆ
                            ‡∏ï‡∏¥‡∏î‡πÄ‡∏Å‡∏°</button>
                        <button onclick="setSituation('‡∏ô‡πâ‡∏≠‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á')"
                            class="text-xs bg-white border border-purple-200 text-purple-600 px-2 py-1 rounded-full hover:bg-purple-100 transition shadow-sm">üìÖ
                            ‡∏≠‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</button>
                        <button onclick="setSituation('‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö')"
                            class="text-xs bg-white border border-purple-200 text-purple-600 px-2 py-1 rounded-full hover:bg-purple-100 transition shadow-sm">ü§ê
                            ‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö</button>
                        <button onclick="setSituation('‡∏ô‡πâ‡∏≠‡∏á‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏π')"
                            class="text-xs bg-white border border-purple-200 text-purple-600 px-2 py-1 rounded-full hover:bg-purple-100 transition shadow-sm">üîí
                            ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡∏≤‡∏ô</button>
                    </div>

                    <button onclick="generateQuestion()"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2.5 px-4 rounded-lg transition text-sm flex justify-center items-center shadow-md">
                        <i class="fas fa-wand-magic-sparkles mr-2"></i> ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button>
                </div>

                <!-- Feature 2: Excuse Buster -->
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm flex items-center">
                        <i class="fas fa-search-plus text-indigo-500 mr-2"></i>2. ‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°? (‡∏à‡∏±‡∏ö‡πÄ‡∏ó‡πá‡∏à)
                    </h3>
                    <textarea id="siblingQuote" rows="2"
                        class="w-full p-3 border border-indigo-200 rounded-lg bg-white text-sm mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-sm"
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î‡∏°‡∏≤... ‡πÄ‡∏ä‡πà‡∏ô '‡πÄ‡∏ß‡πá‡∏ö‡∏•‡πà‡∏° ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'"></textarea>
                    <button onclick="analyzeQuote()"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg transition text-sm flex justify-center items-center shadow-md">
                        <i class="fas fa-microscope mr-2"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å
                    </button>
                </div>

                <!-- AI Output Area -->
                <div id="aiResultContainer" class="hidden animate-fade-in-up">
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                        <div
                            class="bg-gray-100 px-4 py-3 flex justify-between items-center border-b text-sm font-bold text-gray-700">
                            <span><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI</span>
                            <button onclick="closeResult()" class="text-gray-400 hover:text-red-500 transition"><i
                                    class="fas fa-times fa-lg"></i></button>
                        </div>
                        <div id="aiOutputContent" class="p-5 prose-custom text-sm"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- ================= RIGHT COLUMN: UNIVERSITY DATA ================= -->
        <div class="space-y-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-700 flex items-center gap-2">
                    <i class="fas fa-list-ul"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢
                </h2>
                <div class="flex gap-2">
                    <button id="toggleCalBtn" onclick="toggleCalendarView()"
                        class="bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-indigo-200 transition shadow-sm border border-indigo-200 flex items-center">
                        <i class="fas fa-calendar-alt mr-1"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
                    </button>
                    <div id="uniCountBadge"
                        class="bg-white text-blue-700 text-xs font-bold px-3 py-1.5 rounded-full shadow-sm border border-blue-100 flex items-center">
                        0/5
                    </div>
                </div>
            </div>

            <div id="universityList" class="space-y-4 animate-fade-in-up">
                <!-- Cards Injected Here -->
            </div>

            <!-- Calendar View Container -->
            <div id="calendarViewContainer" class="hidden animate-fade-in-up">
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 min-h-[500px] p-4 relative">
                    <div
                        class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500 rounded-t-xl">
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-6 text-center mt-2">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô Admission (‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£)
                    </h3>
                    <div id="calendarViewContent" class="space-y-4">
                        <!-- Events Injected Here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center items-center">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-fade-in-up">
                <div class="bg-gray-100 px-4 py-3 border-b flex justify-between items-center">
                    <h3 class="font-bold text-gray-700"><i class="fas fa-cog text-gray-500 mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    <button onclick="closeSettings()" class="text-gray-400 hover:text-red-500"><i
                            class="fas fa-times"></i></button>
                </div>
                <div class="p-6 space-y-6">

                    <!-- API Key Section -->
                    <!-- General Settings Section -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß & API</label>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-gray-500">GPAX (‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</label>
                                <input type="number" step="0.01" id="gpaxInput" placeholder="0.00"
                                    class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏µ‡πà‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢?</label>
                                <input type="number" id="targetCountInput" value="5" min="1" max="20"
                                    class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Gemini API Key</label>
                                <input type="password" id="apiKeyInput" placeholder="‡∏ß‡∏≤‡∏á API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                                    class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <button onclick="saveSettings()"
                                class="w-full bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                        </div>
                    </div>

                    <hr>

                    <!-- Data Management Section -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup/Restore)</label>
                        <div class="flex gap-2">
                            <button onclick="exportData()"
                                class="flex-1 bg-green-50 text-green-700 border border-green-200 hover:bg-green-100 px-4 py-2 rounded text-sm font-semibold">
                                <i class="fas fa-download mr-1"></i> ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Export)
                            </button>
                            <button onclick="document.getElementById('importFile').click()"
                                class="flex-1 bg-orange-50 text-orange-700 border border-orange-200 hover:bg-orange-100 px-4 py-2 rounded text-sm font-semibold">
                                <i class="fas fa-upload mr-1"></i> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô (Import)
                            </button>
                            <input type="file" id="importFile" class="hidden" accept=".json"
                                onchange="importData(this)">
                        </div>
                    </div>

                    <hr>

                    <!-- Reset Section -->
                    <div>
                        <button onclick="resetData()"
                            class="w-full text-red-500 text-sm hover:bg-red-50 p-2 rounded transition">
                            ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reset Factory)
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Javascript Logic -->
        <script>
            // --- DATA MANAGEMENT (Same as before) ---
            // --- DATA MANAGEMENT & MULTI-ROUND SUPPORT ---
            const defaultUniversities = [
                {
                    id: 1,
                    name: "‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á",
                    faculty: "‡∏Ñ‡∏ì‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á",
                    rounds: {
                        '1': { targetDate: "2025-12-31", officialDate: "2026-01-01", status: "Not Started", remark: "", qualifications: "", conditions: "" },
                        '2': { targetDate: "", officialDate: "", status: "Not Started", remark: "", qualifications: "", conditions: "" },
                        '3': { targetDate: "", officialDate: "", status: "Not Started", remark: "", qualifications: "", scoreCalc: "" },
                        '4': { targetDate: "", officialDate: "", status: "Not Started", remark: "" }
                    },
                    appFee: 0, tuitionFee: 0, dormFee: 0, livingCost: 0
                }
            ];

            let universities = [];
            let geminiApiKey = "";
            let userGpax = "-.-";
            let targetUniCount = 5;
            let currentGlobalRound = '1';

            // --- SUBJECT CONSTANTS ---
            const admissionSubjects = [
                { id: 'TGAT1', name: 'TGAT1 91 ‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©' },
                { id: 'TGAT2', name: 'TGAT2 92 ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' },
                { id: 'TGAT3', name: 'TGAT3 93 ‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' },
                { id: 'TPAT2', name: 'TPAT2 20 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î‡∏®‡∏¥‡∏•‡∏õ‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' },
                { id: 'TPAT3', name: 'TPAT3 30 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡πå-‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ' },
                { id: 'TPAT4', name: 'TPAT4 40 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°' },
                { id: 'TPAT5', name: 'TPAT5 50 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î‡∏Ñ‡∏£‡∏∏‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' },
                { id: 'A-61', name: 'A-Level 61 Math1 ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå 1' },
                { id: 'A-62', name: 'A-Level 62 Math2 ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå 2' },
                { id: 'A-63', name: 'A-Level 63 Sci ‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå' },
                { id: 'A-64', name: 'A-Level 64 Phy ‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå' },
                { id: 'A-65', name: 'A-Level 65 Chem ‡πÄ‡∏Ñ‡∏°‡∏µ' },
                { id: 'A-66', name: 'A-Level 66 Bio ‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤' },
                { id: 'A-70', name: 'A-Level 70 Soc ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤' },
                { id: 'A-81', name: 'A-Level 81 Thai ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢' },
                { id: 'A-82', name: 'A-Level 82 Eng ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©' },
                { id: 'A-83', name: 'A-Level 83 Fra ‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™' },
                { id: 'A-84', name: 'A-Level 84 Deu ‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô' },
                { id: 'A-85', name: 'A-Level 85 Jpn ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô' },
                { id: 'A-86', name: 'A-Level 86 Kor ‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ' },
                { id: 'A-87', name: 'A-Level 87 Chn ‡∏à‡∏µ‡∏ô' },
                { id: 'A-88', name: 'A-Level 88 Bal ‡∏ö‡∏≤‡∏•‡∏µ' },
                { id: 'A-89', name: 'A-Level 89 Esp ‡∏™‡πÄ‡∏õ‡∏ô' }
            ];

            function init() {
                // Load Data
                const savedData = localStorage.getItem('admission_tracker_data');
                if (savedData) {
                    universities = JSON.parse(savedData);
                    migrateData(); // Ensure old data format is updated to new format
                } else {
                    universities = JSON.parse(JSON.stringify(defaultUniversities));
                }

                // Load API Key
                geminiApiKey = localStorage.getItem('gemini_api_key') || "";
                if (geminiApiKey) {
                    document.getElementById('apiKeyInput').value = geminiApiKey;
                }

                // Load GPAX
                userGpax = localStorage.getItem('admission_tracker_gpax') || "-.-";
                document.getElementById('displayGpax').innerText = userGpax;
                document.getElementById('gpaxInput').value = userGpax === "-.-" ? "" : userGpax;

                // Load Target Count
                const savedTarget = localStorage.getItem('admission_target_count');
                targetUniCount = savedTarget ? parseInt(savedTarget) : 5;
                document.getElementById('targetCountInput').value = targetUniCount;

                renderUniversities();
                setTimeout(showWelcomeModal, 800);
            }

            function migrateData() {
                let hasChanges = false;
                universities.forEach(uni => {
                    // If 'rounds' doesn't exist, migrate from flat structure
                    if (!uni.rounds) {
                        uni.rounds = {
                            '1': {
                                targetDate: uni.targetDate || "",
                                officialDate: uni.officialDate || "",
                                status: uni.status || "Not Started",
                                remark: uni.remark || "",
                                qualifications: "", conditions: ""
                            },
                            '2': { targetDate: "", officialDate: "", status: "Not Started", remark: "", qualifications: "", conditions: "" },
                            '3': { targetDate: "", officialDate: "", status: "Not Started", remark: "", qualifications: "", scoreCalc: "" },
                            '4': { targetDate: "", officialDate: "", status: "Not Started", remark: "" }
                        };
                        delete uni.targetDate; delete uni.officialDate; delete uni.status; delete uni.remark; delete uni.activeRound;
                        hasChanges = true;
                    } else {
                        // Ensure new fields exist if migrating from previous version
                        if (uni.rounds['1'] && !uni.rounds['1'].qualifications) { uni.rounds['1'].qualifications = ""; uni.rounds['1'].conditions = ""; hasChanges = true; }
                        if (uni.rounds['2'] && !uni.rounds['2'].qualifications) { uni.rounds['2'].qualifications = ""; uni.rounds['2'].conditions = ""; hasChanges = true; }
                        if (uni.rounds['3'] && !uni.rounds['3'].qualifications) { uni.rounds['3'].qualifications = ""; uni.rounds['3'].scoreCalc = ""; hasChanges = true; }
                        // Update check
                        if (uni.rounds['1'] && !uni.rounds['1'].schedule) { uni.rounds['1'].schedule = []; hasChanges = true; }
                        if (uni.rounds['2'] && !uni.rounds['2'].schedule) { uni.rounds['2'].schedule = []; hasChanges = true; }
                        if (uni.rounds['3'] && !uni.rounds['3'].schedule) { uni.rounds['3'].schedule = []; hasChanges = true; }
                        if (uni.rounds['4'] && !uni.rounds['4'].schedule) { uni.rounds['4'].schedule = []; hasChanges = true; }
                    }
                });
                if (hasChanges) saveToLocal();
            }

            function saveToLocal() {
                localStorage.setItem('admission_tracker_data', JSON.stringify(universities));
                renderUniversities();
            }

            // --- SETTINGS & DATA MANAGEMENT ---
            function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); }
            function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }

            function saveSettings() {
                // Save API Key
                const key = document.getElementById('apiKeyInput').value.trim();
                localStorage.setItem('gemini_api_key', key);
                geminiApiKey = key;

                // Save GPAX
                const gpax = document.getElementById('gpaxInput').value.trim();
                userGpax = gpax || "-.-";
                localStorage.setItem('admission_tracker_gpax', userGpax);
                document.getElementById('displayGpax').innerText = userGpax;

                // Save Target Count
                const targetVal = document.getElementById('targetCountInput').value;
                targetUniCount = targetVal ? parseInt(targetVal) : 5;
                localStorage.setItem('admission_target_count', targetUniCount);
                renderUniversities();

                Swal.fire('Success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
            }

            function exportData() {
                // Bundle data + API Key + GPAX + Target
                const exportObj = {
                    universities: universities,
                    apiKey: geminiApiKey || "",
                    gpax: userGpax,
                    targetCount: targetUniCount
                };

                const dataStr = JSON.stringify(exportObj, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `admission_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                Swal.fire('Downloaded', '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Backup (‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            }

            function importData(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);

                        // Support old format (array only) and new format (object with apiKey)
                        if (Array.isArray(data)) {
                            // Old format: just universities
                            universities = data;
                            saveToLocal();
                            Swal.fire('Success', '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡πÑ‡∏°‡πà‡∏û‡∏ö API Key ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå)', 'success');
                        } else if (data.universities && Array.isArray(data.universities)) {
                            // New format: universities + apiKey + gpax + targetCount
                            universities = data.universities;
                            saveToLocal();

                            // Restore API Key
                            if (data.apiKey) {
                                localStorage.setItem('gemini_api_key', data.apiKey);
                                geminiApiKey = data.apiKey;
                                document.getElementById('apiKeyInput').value = geminiApiKey;
                            }

                            // Restore GPAX
                            if (data.gpax) {
                                localStorage.setItem('admission_tracker_gpax', data.gpax);
                                userGpax = data.gpax;
                                document.getElementById('displayGpax').innerText = userGpax;
                                document.getElementById('gpaxInput').value = userGpax === "-.-" ? "" : userGpax;
                            }

                            // Restore Target Count
                            if (data.targetCount) {
                                localStorage.setItem('admission_target_count', data.targetCount);
                                targetUniCount = data.targetCount;
                                document.getElementById('targetCountInput').value = targetUniCount;
                            }

                            Swal.fire('Success', '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!', 'success');
                        } else {
                            throw new Error('Invalid format');
                        }
                        closeSettings();
                    } catch (err) {
                        console.error(err);
                        Swal.fire('Error', '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    }
                };
                reader.readAsText(file);
                input.value = ''; // Reset input
            }

            function resetData() {
                Swal.fire({
                    title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
                    text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.removeItem('admission_tracker_data');
                        localStorage.removeItem('gemini_api_key');
                        location.reload();
                    }
                })
            }

            function getDaysLeft(dateStr) {
                if (!dateStr) return null;
                const target = new Date(dateStr);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                target.setHours(0, 0, 0, 0);
                return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            }

            function formatDate(dateStr) {
                if (!dateStr) return "-";
                return new Date(dateStr).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
            }

            function setGlobalRound(round) {
                currentGlobalRound = round;
                renderUniversities();
            }

            function renderUniversities() {
                const list = document.getElementById('universityList');
                const countBadge = document.getElementById('uniCountBadge');
                list.innerHTML = '';

                // --- Global Round Tabs ---
                const roundColors = {
                    '1': 'bg-yellow-400 border-yellow-500 text-yellow-900', // Portfolio
                    '2': 'bg-orange-400 border-orange-500 text-white',       // Quota
                    '3': 'bg-teal-500 border-teal-600 text-white',           // Admission
                    '4': 'bg-blue-600 border-blue-700 text-white'            // Direct
                };
                const inactiveClass = 'bg-gray-100 text-gray-400 border-gray-200 hover:bg-gray-200';

                let tabsHtml = `<div class="flex rounded-lg overflow-hidden border border-gray-200 mb-6 shadow-sm">`;
                const rounds = [
                    { id: '1', name: '‡∏£‡∏≠‡∏ö 1 Portfolio', icon: 'fa-folder-open' },
                    { id: '2', name: '‡∏£‡∏≠‡∏ö 2 Quota', icon: 'fa-user-friends' },
                    { id: '3', name: '‡∏£‡∏≠‡∏ö 3 Admission', icon: 'fa-graduation-cap' },
                    { id: '4', name: '‡∏£‡∏≠‡∏ö 4 Direct', icon: 'fa-door-open' },
                ];

                rounds.forEach(r => {
                    const isActive = currentGlobalRound === r.id;
                    const activeStyle = roundColors[r.id];
                    const style = isActive ? `${activeStyle} font-bold shadow-inner` : inactiveClass;
                    tabsHtml += `
                    <button onclick="setGlobalRound('${r.id}')" class="flex-1 py-3 text-sm transition ${style} relative">
                        ${isActive ? '<span class="absolute top-1 right-2 text-[10px] opacity-50"><i class="fas fa-check-circle"></i></span>' : ''}
                        <i class="fas ${r.icon} mr-1"></i> ${r.name}
                    </button>
                `;
                });
                tabsHtml += `</div>`;
                // list.insertAdjacentHTML('beforeend', tabsHtml); // Remove tabs from inside the list container if they are meant to be outside or handle differently.
                // Wait, previously tabs were INSIDE the list. If I want them above the list but list is now space-y-4, that's fine.
                // But the USER wants "‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°" (Vertical).
                // If I inject tabs inside 'universityList', they become the first item in the stack. Correct.
                list.insertAdjacentHTML('beforeend', tabsHtml);
                // -------------------------

                const filledCount = universities.length;
                // document.getElementById('headerTargetCount').innerText = targetUniCount; // This ID might not exist anymore due to recent changes
                if (countBadge) {
                    countBadge.innerText = `${filledCount}/${targetUniCount}`;
                    countBadge.className = filledCount >= targetUniCount ? "bg-green-500 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-sm ml-1 flex items-center" : "bg-white text-blue-700 text-xs font-bold px-3 py-1.5 rounded-full shadow-sm border border-blue-100 ml-1 flex items-center";
                }

                universities.forEach((uni, index) => {
                    const roundData = uni.rounds[currentGlobalRound] || {};

                    // Target Date Logic
                    const daysLeft = getDaysLeft(roundData.targetDate);
                    let daysText = "", daysClass = "";

                    if (daysLeft === null) { daysText = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô"; daysClass = "text-gray-400"; }
                    else if (daysLeft < 0) { daysText = `‡πÄ‡∏•‡∏¢‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${Math.abs(daysLeft)} ‡∏ß‡∏±‡∏ô`; daysClass = "text-red-600 font-bold"; }
                    else if (daysLeft === 0) { daysText = "‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!"; daysClass = "text-red-600 font-bold animate-pulse"; }
                    else { daysText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${daysLeft} ‡∏ß‡∏±‡∏ô`; daysClass = daysLeft <= 5 ? "text-red-500 font-bold" : "text-green-600 font-bold"; }

                    // Official Deadline Logic
                    const offDaysLeft = getDaysLeft(roundData.officialDate);
                    let offDaysText = "", offDaysClass = "";

                    if (offDaysLeft === null) { offDaysText = "‡∏¢‡∏±‡∏á‡∏°‡∏∂‡∏ô‡πÜ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)"; offDaysClass = "text-red-300"; }
                    else if (offDaysLeft < 0) { offDaysText = `‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß (${Math.abs(offDaysLeft)} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß)`; offDaysClass = "text-gray-400 font-bold"; }
                    else if (offDaysLeft === 0) { offDaysText = "‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢!"; offDaysClass = "text-red-700 font-extrabold animate-pulse"; }
                    else { offDaysText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${offDaysLeft} ‡∏ß‡∏±‡∏ô`; offDaysClass = offDaysLeft <= 7 ? "text-red-600 font-bold" : "text-red-400 font-medium"; }

                    const isStarted = roundData.status === "In Progress" || roundData.status === "Done";
                    const borderClass = isStarted ? "border-l-4 border-yellow-400" : "border border-gray-200 opacity-90";

                    // Score Calculation Summary (Round 3)
                    let scoreSummaryHtml = '';
                    if (currentGlobalRound === '3' && roundData.scoreDetails && roundData.scoreDetails.length > 0) {
                        let totalScore = 0;
                        let subjectsHtml = '';

                        roundData.scoreDetails.forEach(item => {
                            const weight = parseFloat(item.weight) || 0;
                            const score = parseFloat(item.score) || 0;
                            const calcScore = (weight * score) / 100;
                            totalScore += calcScore;

                            subjectsHtml += `
                            <div class="mb-1.5">
                                <div class="flex justify-between text-[10px] text-gray-600 mb-0.5">
                                    <span class="font-semibold">${item.subject}</span>
                                    <span class="font-bold text-teal-600">${weight}%</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                    <div class="bg-teal-400 h-1.5 rounded-full" style="width: ${Math.min(weight, 100)}%"></div>
                                </div>
                            </div>
                         `;
                        });

                        scoreSummaryHtml = `
                     <div class="mt-3 bg-gray-50/50 border border-gray-100 rounded-lg p-3">
                        <div class="text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-wider">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Weights)</div>
                        ${subjectsHtml}
                         <div class="mt-2 pt-2 border-t border-gray-200 flex justify-between items-center text-teal-800">
                            <span class="text-xs font-bold"><i class="fas fa-calculator mr-1"></i>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ:</span>
                            <span class="font-extrabold text-sm ml-2 bg-teal-100 px-2 py-0.5 rounded text-teal-700">${totalScore.toFixed(2)}</span>
                         </div>
                     </div>`;
                    }

                    const html = `
                <div class="bg-white p-4 rounded-xl shadow-sm ${borderClass} relative group hover:shadow-md transition">
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
                                <h3 class="font-bold text-lg text-gray-800 break-words">${index + 1}. ${uni.name}</h3>
                                <span class="text-[10px] px-2 py-0.5 rounded-full whitespace-nowrap ${getStatusColor(roundData.status)}">${roundData.status}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2 truncate">${uni.faculty || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ì‡∏∞"}</p>
                            
                            <!-- Detailed Info Preview -->
                            ${roundData.qualifications ? `<div class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded border border-gray-100"><strong class="text-gray-700">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥:</strong> ${roundData.qualifications}</div>` : ''}
                            
                            ${scoreSummaryHtml}

                            <!-- Schedule Preview (Next Event) -->
                            ${getSchedulePreview(roundData.schedule)}
                            
                            ${roundData.remark ? `<p class="text-xs text-gray-400 italic mt-2"><i class="fas fa-comment-alt mr-1"></i>${roundData.remark}</p>` : ''}
                            
                             <!-- Financial (Shared) -->
                            <div class="flex flex-wrap gap-2 text-[10px] mt-2 border-t pt-2 border-gray-100">
                                ${uni.appFee ? `<span class="bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100"><i class="fas fa-tag mr-1"></i>‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${parseInt(uni.appFee).toLocaleString()}</span>` : ''}
                                ${uni.tuitionFee ? `<span class="bg-orange-50 text-orange-700 px-2 py-1 rounded border border-orange-100"><i class="fas fa-university mr-1"></i>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏°: ${parseInt(uni.tuitionFee).toLocaleString()}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="openEditModal(${index})" class="flex-shrink-0 text-gray-400 hover:text-blue-600 transition p-2 bg-gray-50 rounded-lg hover:bg-blue-50"><i class="fas fa-edit"></i></button>
                    </div>
                    
                    <div class="flex gap-3 mt-3">
                        <div class="flex-1 bg-gradient-to-br from-blue-50 to-blue-100/50 p-2 rounded-lg border border-blue-100 text-center cursor-pointer hover:border-blue-300 transition" onclick="openEditModal(${index})">
                            <p class="text-[10px] uppercase text-blue-500 font-bold tracking-wide">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏á</p>
                            <p class="text-lg font-bold text-blue-700 leading-tight mt-1">${formatDate(roundData.targetDate)}</p>
                            <p class="text-[10px] mt-1 ${daysClass}">${daysText}</p>
                        </div>
                        <div class="flex-1 bg-gradient-to-br from-red-50 to-red-100/50 p-2 rounded-lg border border-red-100 text-center cursor-pointer hover:border-red-300 transition group/official" onclick="openEditModal(${index})">
                            <p class="text-[10px] uppercase text-red-500 font-bold tracking-wide group-hover/official:text-red-700">Official Deadline</p>
                            <p class="text-lg font-bold text-red-700 leading-tight mt-1">${formatDate(roundData.officialDate)}</p>
                            <p class="text-[10px] mt-1 ${offDaysClass}">${offDaysText}</p>
                        </div>
                    </div>
                </div>`;
                    list.insertAdjacentHTML('beforeend', html);
                });

                for (let i = universities.length; i < targetUniCount; i++) {
                    const html = `
                <div onclick="openAddModal()" class="dashed-box p-4 rounded-xl flex flex-col items-center justify-center text-center h-32 cursor-pointer group">
                    <div class="bg-white p-3 rounded-full shadow-sm mb-2 group-hover:scale-110 transition group-hover:bg-blue-50"><i class="fas fa-plus text-gray-400 text-xl group-hover:text-blue-500"></i></div>
                    <h4 class="text-gray-500 font-bold text-sm group-hover:text-blue-600">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${i + 1}</h4>
                    <p class="text-xs text-red-400 font-light">‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á! (‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á)</p>
                </div>`;
                    list.insertAdjacentHTML('beforeend', html);
                }
            }

            function getStatusColor(status) {
                if (status === 'In Progress') return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
                if (status === 'Done') return 'bg-green-100 text-green-800 border border-green-200';
                return 'bg-gray-200 text-gray-600';
            }

            // --- SCHEDULE & CALENDAR LOGIC ---
            function getSchedulePreview(schedule) {
                if (!schedule || schedule.length === 0) return '';
                // Find next upcoming event
                const today = new Date().toISOString().split('T')[0];
                const upcoming = schedule
                    .filter(s => s.dateStart >= today)
                    .sort((a, b) => a.dateStart.localeCompare(b.dateStart))[0];

                if (!upcoming) return '';

                return `
            <div class="mt-2 flex items-center gap-2 text-xs bg-indigo-50 text-indigo-800 p-2 rounded border border-indigo-100">
                <i class="fas fa-calendar-alt"></i>
                <span class="font-bold truncate">${upcoming.type}:</span>
                <span>${formatDate(upcoming.dateStart)}</span>
            </div>`;
            }

            window.toggleCalendarView = function () {
                const list = document.getElementById('universityList');
                const cal = document.getElementById('calendarViewContainer');
                const btn = document.getElementById('toggleCalBtn');

                if (cal.classList.contains('hidden')) {
                    list.classList.add('hidden');
                    cal.classList.remove('hidden');
                    btn.innerHTML = '<i class="fas fa-list mr-1"></i> ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                    btn.classList.replace('bg-indigo-100', 'bg-blue-100');
                    btn.classList.replace('text-indigo-700', 'text-blue-700');
                    renderCalendar();
                } else {
                    list.classList.remove('hidden');
                    cal.classList.add('hidden');
                    btn.innerHTML = '<i class="fas fa-calendar-alt mr-1"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô';
                    btn.classList.replace('bg-blue-100', 'bg-indigo-100');
                    btn.classList.replace('text-blue-700', 'text-indigo-700');
                }
            }

            function renderCalendar() {
                const container = document.getElementById('calendarViewContent');
                if (!container) return;
                container.innerHTML = '';

                // Gather all events
                let events = [];
                universities.forEach(uni => {
                    const rData = uni.rounds[currentGlobalRound];
                    if (rData && rData.schedule) {
                        rData.schedule.forEach(ev => {
                            events.push({
                                uniName: uni.name,
                                faculty: uni.faculty,
                                ...ev
                            });
                        });
                    }
                    // Add Target & Official if exists (convert to generic event)
                    if (rData && rData.targetDate) events.push({ uniName: uni.name, faculty: uni.faculty, type: 'Target', dateStart: rData.targetDate, note: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' });
                    if (rData && rData.officialDate) events.push({ uniName: uni.name, faculty: uni.faculty, type: 'Official Deadline', dateStart: rData.officialDate, note: '‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£' });
                });

                // Sort
                events.sort((a, b) => a.dateStart.localeCompare(b.dateStart));

                // Group by Month
                let lastMonth = '';
                events.forEach(ev => {
                    const date = new Date(ev.dateStart);
                    const monthStr = date.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });

                    if (monthStr !== lastMonth) {
                        container.insertAdjacentHTML('beforeend', `<div class="sticky top-0 bg-white/95 backdrop-blur py-2 px-4 shadow-sm z-10 font-bold text-gray-700 border-b border-gray-100 mt-4 text-lg">${monthStr}</div>`);
                        lastMonth = monthStr;
                    }

                    let colorClass = "bg-gray-50 border-gray-200";
                    if (ev.type.includes("‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£") || ev.type.includes("Application")) colorClass = "bg-green-50 border-green-200 text-green-800";
                    if (ev.type.includes("‡∏™‡∏≠‡∏ö") || ev.type.includes("Interview")) colorClass = "bg-yellow-50 border-yellow-200 text-yellow-800";
                    if (ev.type.includes("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®") || ev.type.includes("Announcement")) colorClass = "bg-blue-50 border-blue-200 text-blue-800";
                    if (ev.type.includes("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô") || ev.type.includes("Confirm")) colorClass = "bg-teal-50 border-teal-200 text-teal-800";
                    if (ev.type === "Official Deadline") colorClass = "bg-red-50 border-red-200 text-red-800";

                    const html = `
                 <div class="flex gap-4 p-3 mx-4 my-2 rounded-lg border ${colorClass} items-start">
                    <div class="text-center w-16 flex-shrink-0">
                         <div class="text-2xl font-bold leading-none">${date.getDate()}</div>
                         <div class="text-[10px] uppercase opacity-70">${date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-sm">${ev.type}</h4>
                            ${ev.dateEnd ? `<span class="text-[10px] bg-white/50 px-1.5 rounded border border-black/5">‡∏ñ‡∏∂‡∏á ${formatDate(ev.dateEnd)}</span>` : ''}
                        </div>
                        <p class="text-sm font-medium mt-0.5 line-clamp-1">${ev.uniName} <span class="font-normal opacity-80">- ${ev.faculty}</span></p>
                        ${ev.note ? `<p class="text-xs opacity-70 mt-1"><i class="fas fa-info-circle mr-1"></i>${ev.note}</p>` : ''}
                    </div>
                 </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });

                if (events.length === 0) {
                    container.innerHTML = `<div class="text-center py-10 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</div>`;
                }
            }

            window.addScheduleRow = function () {
                const type = document.getElementById('new-sched-type').value;
                const start = document.getElementById('new-sched-start').value;
                const end = document.getElementById('new-sched-end').value;
                const note = document.getElementById('new-sched-note').value;

                if (!start) return;

                const container = document.getElementById('schedule-rows-container');
                const rowHtml = `
             <div class="sched-row flex gap-2 mb-2 items-center bg-white p-2 border border-gray-100 rounded shadow-sm">
                <div class="w-24 flex-shrink-0">
                    <input type="text" class="sched-input-type w-full p-1 text-xs border rounded bg-gray-50 font-bold text-indigo-700" value="${type}" readonly>
                </div>
                <div class="flex-1 flex gap-1 items-center">
                    <input type="date" class="sched-input-start p-1 text-[10px] border rounded text-center w-20" value="${start}" readonly>
                    ${end ? `<span class="text-gray-400">-</span><input type="date" class="sched-input-end p-1 text-[10px] border rounded text-center w-20" value="${end}" readonly>` : '<input type="hidden" class="sched-input-end" value="">'}
                </div>
                <input type="hidden" class="sched-input-note" value="${note}">
                <button type="button" onclick="removeSchedRow(this)" class="text-red-400 hover:text-red-600 w-6"><i class="fas fa-times"></i></button>
            </div>`;
                container.insertAdjacentHTML('beforeend', rowHtml);

                // clear
                document.getElementById('new-sched-start').value = '';
                document.getElementById('new-sched-end').value = '';
                document.getElementById('new-sched-note').value = '';
            }
            window.removeSchedRow = function (btn) { btn.closest('.sched-row').remove(); }

            // --- EDIT MODAL WITH TABS ---
            window.switchEditTab = function (round) {
                // Update Tab Buttons
                document.querySelectorAll('.edit-tab-btn').forEach(btn => {
                    let activeColor = "";
                    if (round === '1') activeColor = "bg-yellow-100 text-yellow-800 border-yellow-300";
                    if (round === '2') activeColor = "bg-orange-100 text-orange-800 border-orange-300";
                    if (round === '3') activeColor = "bg-teal-100 text-teal-800 border-teal-300";
                    if (round === '4') activeColor = "bg-blue-100 text-blue-800 border-blue-300";

                    if (btn.dataset.round === round) {
                        btn.className = `edit-tab-btn flex-1 py-2 px-3 rounded-lg text-xs font-bold border transition whitespace-nowrap shadow-sm ${activeColor}`;
                    } else {
                        btn.className = `edit-tab-btn flex-1 py-2 px-3 rounded-lg text-xs font-bold border border-transparent text-gray-400 hover:text-gray-600 hover:bg-gray-50 transition whitespace-nowrap`;
                    }
                });
                // Update Content
                document.querySelectorAll('.edit-tab-content').forEach(content => {
                    if (content.id === `edit-content-${round}`) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
            }

            // --- SCORE CALCULATOR HELPERS ---
            window.addScoreRow = function () {
                const subjectId = document.getElementById('new-score-subject').value;
                const subjectName = document.getElementById('new-score-subject').options[document.getElementById('new-score-subject').selectedIndex].text;
                const weight = document.getElementById('new-score-weight').value;
                const score = document.getElementById('new-score-val').value;

                if (!subjectId) return;

                const container = document.getElementById('score-rows-container');
                const rowHtml = `
                <div class="score-row flex gap-2 mb-2 items-center bg-white p-2 border border-gray-100 rounded shadow-sm">
                    <input type="hidden" class="score-input-id" value="${subjectId}">
                    <div class="flex-1 text-xs text-gray-700 truncate font-semibold" title="${subjectName}">
                        <span class="bg-gray-100 text-gray-500 text-[9px] px-1 py-0.5 rounded mr-1">${subjectId}</span>
                        ${subjectName.replace(subjectId, '')}
                    </div>
                    <div class="w-16 relative">
                         <span class="absolute right-6 top-1.5 text-[9px] text-gray-400">%</span>
                         <input type="number" class="score-input-weight w-full p-1 border rounded text-xs text-center outline-none focus:border-teal-400" value="${weight}" onchange="updateScoreTotal()" placeholder="0">
                    </div>
                    <div class="w-16">
                        <input type="number" class="score-input-val w-full p-1 border rounded text-xs text-center outline-none focus:border-teal-400" value="${score}" onchange="updateScoreTotal()" placeholder="0">
                    </div>
                    <button type="button" onclick="removeScoreRow(this)" class="text-red-400 hover:text-red-600 w-6"><i class="fas fa-times"></i></button>
                </div>
            `;
                container.insertAdjacentHTML('beforeend', rowHtml);

                // Reset inputs
                document.getElementById('new-score-weight').value = '';
                document.getElementById('new-score-val').value = '';
                document.getElementById('new-score-subject').selectedIndex = 0;
                updateScoreTotal();
            }

            window.removeScoreRow = function (btn) {
                btn.closest('.score-row').remove();
                updateScoreTotal();
            }

            window.updateScoreTotal = function () {
                let total = 0;
                document.querySelectorAll('.score-row').forEach(row => {
                    const w = parseFloat(row.querySelector('.score-input-weight').value) || 0;
                    const s = parseFloat(row.querySelector('.score-input-val').value) || 0;
                    total += (w * s) / 100;
                });
                const display = document.getElementById('score-total-display');
                if (display) display.innerText = total.toFixed(2);
            }

            async function openEditModal(index) {
                const uni = universities[index];
                const activeRound = currentGlobalRound;

                const { value: formValues } = await Swal.fire({
                    title: `<span class="text-2xl font-bold text-gray-700">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢</span>`,
                    html: generateModalHtml(uni),
                    width: '700px',
                    showCancelButton: true,
                    confirmButtonText: '<i class="fas fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                    confirmButtonColor: '#2563EB',
                    cancelButtonText: '<i class="fas fa-trash-alt mr-1"></i> ‡∏•‡∏ö‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏µ‡πâ',
                    cancelButtonColor: '#EF4444',
                    focusConfirm: false,
                    customClass: { popup: 'rounded-2xl', container: 'font-sarabun' },
                    didOpen: () => {
                        // Activate the current round tab by default
                        window.switchEditTab(activeRound);
                    },
                    preConfirm: () => getModalValues()
                });

                if (formValues) {
                    universities[index] = { ...universities[index], ...formValues };
                    saveToLocal();
                } else if (Swal.getDismissReason() === Swal.DismissReason.cancel) {
                    if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏µ‡πâ?')) { universities.splice(index, 1); saveToLocal(); }
                }
            }

            async function openAddModal() {
                // Default empty structure
                const emptyUni = {
                    rounds: {
                        '1': { status: 'Not Started' }, '2': { status: 'Not Started' },
                        '3': { status: 'Not Started' }, '4': { status: 'Not Started' }
                    },
                    activeRound: currentGlobalRound
                };

                const { value: formValues } = await Swal.fire({
                    title: `<span class="text-2xl font-bold text-gray-700">‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡πÉ‡∏´‡∏°‡πà</span>`,
                    html: generateModalHtml(emptyUni),
                    width: '700px',
                    showCancelButton: true,
                    confirmButtonText: '<i class="fas fa-plus mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
                    confirmButtonColor: '#10B981',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    focusConfirm: false,
                    customClass: { popup: 'rounded-2xl', container: 'font-sarabun' },
                    didOpen: () => { window.switchEditTab(currentGlobalRound); },
                    preConfirm: () => getModalValues()
                });
                if (formValues) {
                    universities.push({ id: Date.now(), ...formValues });
                    saveToLocal();
                }
            }

            function generateModalHtml(data) {
                const val = (key) => data[key] || '';
                const rounds = data.rounds || {
                    '1': { status: 'Not Started' }, '2': { status: 'Not Started' },
                    '3': { status: 'Not Started' }, '4': { status: 'Not Started' }
                };

                let tabsHtml = `<div class="flex gap-2 mb-4 border-b pb-2 overflow-x-auto">`;
                const roundNames = { '1': '1. Portfolio', '2': '2. Quota', '3': '3. Admission', '4': '4. Direct' };

                ['1', '2', '3', '4'].forEach(r => {
                    tabsHtml += `
                <button type="button" data-round="${r}" onclick="switchEditTab('${r}')" 
                    class="edit-tab-btn flex-1 py-2 px-3 rounded-lg text-xs font-bold border border-transparent transition whitespace-nowrap">
                    ${roundNames[r]}
                </button>`;
                });
                tabsHtml += `</div>`;

                let roundsContentHtml = '';
                ['1', '2', '3', '4'].forEach(r => {
                    const rData = rounds[r] || {};

                    // --- Input Fields Custom Logic per Round ---
                    let extendedInputs = '';
                    if (r === '1' || r === '2') {
                        extendedInputs = `
                    <div class="mt-3 space-y-3 p-3 bg-white rounded-lg border border-gray-100">
                         <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">üéì ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ (Qualifications)</label>
                            <textarea id="swal-qual-${r}" rows="3" class="w-full p-2 border border-gray-200 rounded text-sm focus:ring-2 focus:ring-blue-100 outline-none" placeholder="- GPAX > 3.00&#10;- ‡∏à‡∏ö‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...">${rData.qualifications || ''}</textarea>
                         </div>
                         <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">üìã ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö (Conditions)</label>
                            <textarea id="swal-cond-${r}" rows="2" class="w-full p-2 border border-gray-200 rounded text-sm focus:ring-2 focus:ring-blue-100 outline-none" placeholder="- ‡πÅ‡∏ü‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ú‡∏•‡∏á‡∏≤‡∏ô 10 ‡∏´‡∏ô‡πâ‡∏≤&#10;- ‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©">${rData.conditions || ''}</textarea>
                         </div>
                    </div>`;
                    } else if (r === '3') {
                        // Generate existing rows
                        const scoreDetails = rData.scoreDetails || [];
                        let initialRows = '';
                        let totalScore = 0;

                        scoreDetails.forEach(item => {
                            const subj = admissionSubjects.find(s => s.id === item.subject) || { name: item.subject };
                            const w = parseFloat(item.weight) || 0;
                            const s = parseFloat(item.score) || 0;
                            totalScore += (w * s) / 100;

                            initialRows += `
                            <div class="score-row flex gap-2 mb-2 items-center bg-white p-2 border border-gray-100 rounded shadow-sm">
                                <input type="hidden" class="score-input-id" value="${item.subject}">
                                <div class="flex-1 text-xs text-gray-700 truncate font-semibold" title="${subj.name}">
                                     <span class="bg-gray-100 text-gray-500 text-[9px] px-1 py-0.5 rounded mr-1">${item.subject}</span>
                                     ${subj.name.replace(item.subject, '')}
                                </div>
                                <div class="w-16 relative">
                                     <span class="absolute right-6 top-1.5 text-[9px] text-gray-400">%</span>
                                     <input type="number" class="score-input-weight w-full p-1 border rounded text-xs text-center outline-none focus:border-teal-400" value="${item.weight}" onchange="updateScoreTotal()" placeholder="0">
                                </div>
                                <div class="w-16">
                                    <input type="number" class="score-input-val w-full p-1 border rounded text-xs text-center outline-none focus:border-teal-400" value="${item.score}" onchange="updateScoreTotal()" placeholder="0">
                                </div>
                                <button type="button" onclick="removeScoreRow(this)" class="text-red-400 hover:text-red-600 w-6"><i class="fas fa-times"></i></button>
                            </div>`;
                        });

                        // Generate Options
                        let optionsHtml = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>';
                        admissionSubjects.forEach(s => optionsHtml += `<option value="${s.id}">${s.name}</option>`);

                        extendedInputs = `
                    <div class="mt-3 space-y-3 p-3 bg-white rounded-lg border border-gray-100">
                         <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">üéì ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Basic Info)</label>
                            <textarea id="swal-qual-${r}" rows="2" class="w-full p-2 border border-gray-200 rounded text-sm focus:ring-2 focus:ring-teal-100 outline-none" placeholder="- ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡πå-‡∏Ñ‡∏ì‡∏¥‡∏ï&#10;- GPAX 6 ‡πÄ‡∏ó‡∏≠‡∏°">${rData.qualifications || ''}</textarea>
                         </div>
                         
                         <div class="bg-teal-50/50 p-3 rounded-lg border border-teal-100">
                            <label class="block text-xs font-bold text-teal-800 mb-2">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Score Calculator)</label>
                            
                            <!-- Header -->
                            <div class="flex gap-2 text-[10px] text-gray-500 mb-1 px-1">
                                <div class="flex-1">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á</div>
                                <div class="w-16 text-center">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å %</div>
                                <div class="w-16 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</div>
                                <div class="w-6"></div>
                            </div>

                            <div id="score-rows-container" class="space-y-1 mb-3 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                                ${initialRows}
                            </div>

                            <!-- Add New Row -->
                            <div class="flex gap-2 items-end bg-white p-2 rounded border border-teal-200 shadow-sm">
                                <div class="flex-1">
                                    <select id="new-score-subject" class="w-full text-xs p-1.5 border border-gray-200 rounded bg-white outline-none">
                                        ${optionsHtml}
                                    </select>
                                </div>
                                <div class="w-16">
                                    <input type="number" id="new-score-weight" class="w-full text-xs p-1.5 border border-gray-200 rounded text-center outline-none" placeholder="%">
                                </div>
                                 <div class="w-16">
                                    <input type="number" id="new-score-val" class="w-full text-xs p-1.5 border border-gray-200 rounded text-center outline-none" placeholder="Score">
                                </div>
                                <button type="button" onclick="addScoreRow()" class="bg-teal-500 text-white rounded p-1.5 hover:bg-teal-600 transition w-6 flex items-center justify-center"><i class="fas fa-plus text-xs"></i></button>
                            </div>
                            
                            <div class="mt-2 flex justify-between items-center bg-teal-100 p-2 rounded text-teal-800 font-bold text-xs">
                                <span>‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                                <span id="score-total-display">${totalScore.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>`;
                    }

                    // --- CALENDAR SCHEDULE SECTION (ALL ROUNDS) ---
                    const schedule = rData.schedule || [];
                    let schedRows = '';
                    schedule.forEach(s => {
                        schedRows += `
                    <div class="sched-row flex gap-2 mb-2 items-center bg-white p-2 border border-gray-100 rounded shadow-sm">
                        <div class="w-24 flex-shrink-0"><input type="text" class="sched-input-type w-full p-1 text-xs border rounded bg-gray-50 font-bold text-indigo-700" value="${s.type}" readonly></div>
                        <div class="flex-1 flex gap-1 items-center">
                            <input type="date" class="sched-input-start p-1 text-[10px] border rounded text-center w-20" value="${s.dateStart}" readonly>
                            ${s.dateEnd ? `<span class="text-gray-400">-</span><input type="date" class="sched-input-end p-1 text-[10px] border rounded text-center w-20" value="${s.dateEnd}" readonly>` : '<input type="hidden" class="sched-input-end" value="">'}
                        </div>
                        <input type="hidden" class="sched-input-note" value="${s.note || ''}">
                        <button type="button" onclick="removeSchedRow(this)" class="text-red-400 hover:text-red-600 w-6"><i class="fas fa-times"></i></button>
                    </div>`;
                    });

                    roundsContentHtml += `
                <div id="edit-content-${r}" class="edit-tab-content hidden space-y-4 animate-fade-in-up">
                    <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                        <label class="block text-xs font-bold text-indigo-800 mb-3 uppercase tracking-wide border-b border-indigo-100 pb-1">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                        
                        <div id="schedule-rows-container" class="space-y-1 mb-3 max-h-40 overflow-y-auto pr-1">
                            ${schedRows}
                        </div>
                        
                        <!-- Add Sched -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                             <div>
                                <label class="text-[10px] text-gray-500">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                                <select id="new-sched-type" class="w-full text-xs p-1.5 border rounded">
                                    <option value="‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£">‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</option>
                                    <option value="‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå">‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå</option>
                                    <option value="‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•</option>
                                    <option value="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</option>
                                    <option value="‡∏™‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå">‡∏™‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</option>
                                    <option value="‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</option>
                                </select>
                             </div>
                             <div>
                                <label class="text-[10px] text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/Note</label>
                                <input id="new-sched-note" class="w-full text-xs p-1.5 border rounded" placeholder="‡πÄ‡∏ä‡πà‡∏ô mytcas.com">
                             </div>
                        </div>
                        <div class="flex gap-2 items-end">
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-500">‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                                <input type="date" id="new-sched-start" class="w-full text-xs p-1.5 border rounded">
                            </div>
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-500">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                                <input type="date" id="new-sched-end" class="w-full text-xs p-1.5 border rounded">
                            </div>
                            <button type="button" onclick="addScheduleRow()" class="bg-indigo-500 text-white rounded p-1.5 w-8 h-8 flex items-center justify-center hover:bg-indigo-600"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                
                    <!-- Legacy Status & Timeline (Hidden/Optional if using Schedule but kept for backward comp) -->
                     <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div class="w-1/3">
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Status</label>
                            <select id="swal-status-${r}" class="w-full p-1.5 border border-gray-300 rounded text-xs bg-white outline-none">
                                <option value="Not Started" ${rData.status === 'Not Started' ? 'selected' : ''}>‚ö™ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</option>
                                <option value="In Progress" ${rData.status === 'In Progress' ? 'selected' : ''}>üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                                <option value="Done" ${rData.status === 'Done' ? 'selected' : ''}>üü¢ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
                            </select>
                        </div>
                        <div class="flex gap-2 opacity-50 hover:opacity-100 transition">
                             <div><label class="text-[10px] text-gray-400 block mb-1">Target</label><input type="date" id="swal-target-${r}" class="w-24 p-1.5 border rounded text-xs" value="${rData.targetDate || ''}"></div>
                             <div><label class="text-[10px] text-red-300 block mb-1">Dead</label><input type="date" id="swal-official-${r}" class="w-24 p-1.5 border rounded text-xs" value="${rData.officialDate || ''}"></div>
                        </div>
                    </div>

                    ${extendedInputs}

                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">üìù Memo</label>
                        <textarea id="swal-remark-${r}" rows="2" class="w-full p-2.5 border border-gray-300 rounded-lg text-sm">${rData.remark || ''}</textarea>
                    </div>
                </div>`;
                });

                return `
            <div class="text-left px-1 py-1">
                <!-- Section 1: Identity (Common) -->
                <div class="space-y-3 mb-4">
                    <div class="flex gap-3">
                        <div class="flex-1">
                             <label class="block text-xs font-bold text-gray-700 mb-1 px-1">‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</label>
                             <input id="swal-name" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏á‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢" value="${val('name')}">
                        </div>
                        <div class="flex-1">
                             <label class="block text-xs font-bold text-gray-700 mb-1 px-1">‡∏Ñ‡∏ì‡∏∞/‡∏™‡∏≤‡∏Ç‡∏≤</label>
                             <input id="swal-faculty" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:bg-white outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå" value="${val('faculty')}">
                        </div>
                    </div>
                </div>

                ${tabsHtml}
                ${roundsContentHtml}

                <!-- Financials (Common) -->
                 <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mt-4">
                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö)</label>
                    <div class="grid grid-cols-4 gap-2">
                         <div>
                            <label class="block text-[9px] text-gray-400 mb-1">‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≠‡∏ö</label>
                            <input type="number" id="swal-appFee" class="w-full p-1.5 border border-gray-200 rounded text-xs outline-none bg-white text-center" value="${val('appFee')}" placeholder="0">
                         </div>
                         <div>
                            <label class="block text-[9px] text-gray-400 mb-1">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏°</label>
                            <input type="number" id="swal-tuitionFee" class="w-full p-1.5 border border-gray-200 rounded text-xs outline-none bg-white text-center" value="${val('tuitionFee')}" placeholder="0">
                         </div>
                         <div>
                            <label class="block text-[9px] text-gray-400 mb-1">‡∏Ñ‡πà‡∏≤‡∏´‡∏≠/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                            <input type="number" id="swal-dormFee" class="w-full p-1.5 border border-gray-200 rounded text-xs outline-none bg-white text-center" value="${val('dormFee')}" placeholder="0">
                         </div>
                         <div>
                            <label class="block text-[9px] text-gray-400 mb-1">‡∏Å‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                            <input type="number" id="swal-livingCost" class="w-full p-1.5 border border-gray-200 rounded text-xs outline-none bg-white text-center" value="${val('livingCost')}" placeholder="0">
                         </div>
                    </div>
                </div>
            </div>`;
            }

            function getModalValues() {
                const rounds = {};
                ['1', '2', '3', '4'].forEach(r => {
                    const base = {
                        targetDate: document.getElementById(`swal-target-${r}`).value,
                        officialDate: document.getElementById(`swal-official-${r}`).value,
                        status: document.getElementById(`swal-status-${r}`).value,
                        remark: document.getElementById(`swal-remark-${r}`).value
                    };

                    // Capture extended fields
                    if (r === '1' || r === '2') {
                        base.qualifications = document.getElementById(`swal-qual-${r}`).value;
                        base.conditions = document.getElementById(`swal-cond-${r}`).value;
                    }
                    if (r === '3') {
                        base.qualifications = document.getElementById(`swal-qual-${r}`).value;

                        // Capture Score Details
                        const scoreRows = document.querySelectorAll('.score-row');
                        const scoreDetails = [];
                        scoreRows.forEach(row => {
                            scoreDetails.push({
                                subject: row.querySelector('.score-input-id').value,
                                weight: row.querySelector('.score-input-weight').value,
                                score: row.querySelector('.score-input-val').value
                            });
                        });
                        base.scoreDetails = scoreDetails;
                    }

                    // Capture Schedule
                    // Only if sched rows exist in this tab? 
                    // The sched rows are now rendered INSIDE the tab loop in HTML generation
                    // But getElementById needs to be scoped or find within specific containers if IDs are reused...
                    // Wait, HTML gen used dynamic content but IDs for 'new-sched-...' are reused if I rendered them in every tab.
                    // Actually, I put the Sched Input block inside the tab loop. 
                    // But `getElementById('new-sched-type')` will conflict if multiple tabs have it?
                    // Visual tabs hide content, but DOM has them all. ID conflict!
                    // FIX: getModalValues should scope search, or I should have unique IDs per round.
                    // Let's assume user edits one round. 
                    // BETTER: Use classes and querySelector relative to `edit-content-${r}`.

                    const tabContent = document.getElementById(`edit-content-${r}`);
                    if (tabContent) {
                        const schedRows = tabContent.querySelectorAll('.sched-row');
                        const schedule = [];
                        schedRows.forEach(row => {
                            schedule.push({
                                type: row.querySelector('.sched-input-type').value,
                                dateStart: row.querySelector('.sched-input-start').value,
                                dateEnd: row.querySelector('.sched-input-end') ? row.querySelector('.sched-input-end').value : '',
                                note: row.querySelector('.sched-input-note').value
                            });
                        });
                        base.schedule = schedule;
                    }

                    rounds[r] = base;
                });

                return {
                    name: document.getElementById('swal-name').value,
                    faculty: document.getElementById('swal-faculty').value,
                    appFee: document.getElementById('swal-appFee').value,
                    tuitionFee: document.getElementById('swal-tuitionFee').value,
                    dormFee: document.getElementById('swal-dormFee').value,
                    livingCost: document.getElementById('swal-livingCost').value,
                    rounds: rounds
                };
            }

            // --- AI LOGIC (Enhanced Prompts) ---
            function setSituation(text) { document.getElementById('situationInput').value = text; }

            async function callGemini(prompt) {
                if (!geminiApiKey) {
                    Swal.fire('API Key Missing', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI', 'warning');
                    return "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
                }
                const apiKey = geminiApiKey;
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) { console.error(error); return "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"; }
            }

            function showResult(html) {
                const container = document.getElementById('aiResultContainer');
                document.getElementById('aiOutputContent').innerHTML = html;
                container.classList.remove('hidden');
            }
            function closeResult() { document.getElementById('aiResultContainer').classList.add('hidden'); }
            function setLoading(btn) {
                document.getElementById('aiResultContainer').classList.remove('hidden');
                document.getElementById('aiOutputContent').innerHTML = '<div class="text-center py-8 text-purple-600"><i class="fas fa-spinner fa-spin fa-2x mb-3"></i><br>AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å...</div>';
                btn.disabled = true; btn.classList.add('opacity-50');
            }
            function clearLoading(btn) { btn.disabled = false; btn.classList.remove('opacity-50'); }

            async function generateQuestion() {
                const situation = document.getElementById('situationInput').value;
                if (!situation.trim()) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
                const btn = document.querySelector('button[onclick="generateQuestion()"]');
                setLoading(btn);

                const prompt = `
                Role: ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß (Family Counselor)
                Task: ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏û‡∏µ‡πà‡∏™‡∏≤‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≠‡∏á (‡∏°.6, TCAS69)
                Situation: "${situation}"
                
                Instruction: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÇ‡∏î‡∏¢‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
                1. üß† **‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ô‡πâ‡∏≠‡∏á:** ‡∏ó‡∏≥‡πÑ‡∏°‡∏ô‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ? (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏•‡∏±‡∏ß‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß, ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏™‡∏∞‡∏™‡∏°, ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≠‡∏≠‡πâ‡∏≤‡∏á) ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô
                2. üó£Ô∏è **‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ (Scripts):**
                   - üç¨ **‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡∏°‡∏∏‡∏ô (Soft Approach):** ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à
                   - üî• **‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô (Nudge Approach):** ‡∏ä‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏î‡∏∏‡∏î‡πà‡∏≤
                   - üõ°Ô∏è **‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î (Firm Boundary):** ‡∏ñ‡πâ‡∏≤ 2 ‡πÅ‡∏ö‡∏ö‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏• ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≤‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£
                3. üí° **‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:** ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
                
                Format: HTML (‡πÉ‡∏ä‡πâ <h3>, <ul>, <li>, <strong>, <p> ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢) (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Markdown code block)
            `;
                const result = await callGemini(prompt);
                // Clean markdown code blocks if Gemini sends them despite instructions
                const cleanResult = result.replace(/```html/g, '').replace(/```/g, '');
                showResult(cleanResult);
                clearLoading(btn);
            }

            async function analyzeQuote() {
                const quote = document.getElementById('siblingQuote').value;
                if (!quote.trim()) return Swal.fire('‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
                const btn = document.querySelector('button[onclick="analyzeQuote()"]');
                setLoading(btn);

                const prompt = `
                Role: ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏£‡∏∞‡∏ö‡∏ö TCAS ‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡∏à‡∏±‡∏ö‡πÇ‡∏Å‡∏´‡∏Å (Fact Checker)
                Task: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏á: "${quote}"
                
                Instruction: ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:
                1. üîç **‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠ (Verdict):** (‡∏™‡∏π‡∏á/‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡∏ï‡πà‡∏≥) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
                2. üßê **‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:** ‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô? ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏≠‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                3. üïµÔ∏è **‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Investigate):** ‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà "‡∏î‡∏¥‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏∏‡∏î" (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏´‡∏ô, ‡∏Ç‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏´‡∏ô)
                4. üé≠ **‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà:** ‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡πÇ‡∏Å‡∏´‡∏Å ‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£?
                
                Format: HTML (‡πÉ‡∏ä‡πâ <h3>, <ul>, <li>, <strong>, <p> ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢) (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Markdown code block)
            `;
                const result = await callGemini(prompt);
                // Clean markdown code blocks
                const cleanResult = result.replace(/```html/g, '').replace(/```/g, '');
                showResult(cleanResult);
                clearLoading(btn);
            }

            async function quickSetApiKey() {
                Swal.close();
                const { value: key } = await Swal.fire({
                    title: '‡πÉ‡∏™‡πà Gemini API Key',
                    input: 'text',
                    inputAttributes: {
                        autocapitalize: 'off'
                    },
                    inputPlaceholder: 'Paste your API Key here...',
                    showCancelButton: true,
                    confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                    confirmButtonColor: '#7c3aed',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                });

                if (key) {
                    localStorage.setItem('gemini_api_key', key.trim());
                    geminiApiKey = key.trim();
                    document.getElementById('apiKeyInput').value = geminiApiKey; // Sync with settings
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Key ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                        text: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI Assistant ‡πÅ‡∏•‡πâ‡∏ß!',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            }

            function showWelcomeModal() {
                if (sessionStorage.getItem('intro_seen')) return;

                Swal.fire({
                    title: 'üêª ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö!',
                    html: `
                    <div class="text-left text-sm space-y-4">
                        <div class="bg-blue-50 p-3 rounded border border-blue-100 text-blue-800">
                             <i class="fas fa-info-circle mr-1"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="document.getElementById('importFile').click(); Swal.close();" 
                                class="text-left w-full bg-white hover:bg-orange-50 text-gray-700 hover:text-orange-700 p-3 rounded border border-gray-200 hover:border-orange-200 transition flex items-center shadow-sm group">
                                <span class="bg-orange-100 text-orange-600 p-2.5 rounded-full mr-3 group-hover:scale-110 transition"><i class="fas fa-file-import"></i></span>
                                <div>
                                    <div class="font-bold">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (Restore)</div>
                                    <div class="text-xs text-gray-500 group-hover:text-orange-600">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠ Restoe ‡πÑ‡∏ü‡∏•‡πå Backup ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤</div>
                                </div>
                            </button>
                            
                            <button onclick="quickSetApiKey()" 
                                class="text-left w-full bg-white hover:bg-purple-50 text-gray-700 hover:text-purple-700 p-3 rounded border border-gray-200 hover:border-purple-200 transition flex items-center shadow-sm group">
                                <span class="bg-purple-100 text-purple-600 p-2.5 rounded-full mr-3 group-hover:scale-110 transition"><i class="fas fa-key"></i></span>
                                <div>
                                    <div class="font-bold">‡πÉ‡∏™‡πà API Key (AI)</div>
                                    <div class="text-xs text-gray-500 group-hover:text-purple-600">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
                                </div>
                            </button>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t text-xs text-center text-gray-400">
                            <p class="mb-2"><i class="fas fa-exclamation-triangle"></i> ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô Cloud</p>
                            <p><b>‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏° Backup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</b> ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
                        </div>

                        <div class="mt-2 text-center">
                             <button onclick="Swal.close()" class="text-gray-400 text-xs hover:text-gray-600 font-semibold underline">
                                ‚úï ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠)
                             </button>
                        </div>
                    </div>
                `,
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    padding: '2rem',
                    width: '420px',
                    background: '#fff',
                    backdrop: `
                    rgba(0,0,123,0.4)
                    left top
                    no-repeat
                `
                }).then(() => {
                    sessionStorage.setItem('intro_seen', 'true');
                });
            }

            // --- EXIT WARNING ---
            window.addEventListener('beforeunload', function (e) {
                e.preventDefault();
                e.returnValue = ''; // Trigger browser warning
            });

            // --- BUDGET PLANNER ---
            function openBudgetPlanner() {
                if (universities.length === 0) return Swal.fire('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Budget Planner', 'info');

                // Prepare Data for Stacked Chart
                const labels = [];
                const tuitionData = [];
                const dormData = [];
                const livingData = [];
                const appData = [];

                // Color mapping for list
                const colors = ['#EF4444', '#3B82F6', '#F59E0B', '#10B981', '#8B5CF6', '#EC4899'];

                let htmlDetail = `<div class="space-y-3 mt-4 h-60 overflow-y-auto custom-scrollbar p-1">`;

                universities.forEach((uni, index) => {
                    const tuition = parseInt(uni.tuitionFee || 0);
                    const dorm = parseInt(uni.dormFee || 0);
                    const living = parseInt(uni.livingCost || 0);
                    const app = parseInt(uni.appFee || 0);

                    // Calculation: 1 Year
                    const yearlyTuition = tuition * 2;
                    const yearlyDorm = dorm * 12;
                    const yearlyLiving = living * 12;
                    const total = yearlyTuition + yearlyDorm + yearlyLiving + app;

                    labels.push(`M${index + 1}`);
                    tuitionData.push(yearlyTuition);
                    dormData.push(yearlyDorm);
                    livingData.push(yearlyLiving);
                    appData.push(app);

                    htmlDetail += `
                    <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center group hover:border-blue-300 transition">
                        <div class="flex items-center gap-3 overflow-hidden">
                             <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs flex-shrink-0" style="background-color: ${colors[index % colors.length]}">
                                M${index + 1}
                             </div>
                             <div class="min-w-0">
                                <div class="font-bold text-gray-700 text-sm truncate">${uni.name}</div>
                                <div class="text-[10px] text-gray-400 flex gap-2">
                                    <span><i class="fas fa-university text-red-400"></i> ${yearlyTuition.toLocaleString()}</span>
                                    <span><i class="fas fa-bed text-blue-400"></i> ${yearlyDorm.toLocaleString()}</span>
                                    <span><i class="fas fa-utensils text-yellow-500"></i> ${yearlyLiving.toLocaleString()}</span>
                                </div>
                             </div>
                        </div>
                        <div class="font-bold text-blue-600 text-sm whitespace-nowrap">‡∏ø ${total.toLocaleString()}</div>
                    </div>`;
                });

                htmlDetail += `</div>`;

                const htmlContent = `
                <div class="bg-gray-50 rounded-xl p-2 mb-4 relative">
                     <div style="height: 300px;">
                        <canvas id="budgetChart"></canvas>
                     </div>
                </div>
                ${htmlDetail}
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs text-left text-yellow-800">
                    <i class="fas fa-info-circle mr-1"></i> <b>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏ï‡πà‡∏≠‡∏õ‡∏µ):</b><br>
                    <span class="inline-block w-3 h-3 bg-red-400 rounded-full mr-1"></span>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏°
                    <span class="inline-block w-3 h-3 bg-blue-400 rounded-full mr-1 ml-2"></span>‡∏Ñ‡πà‡∏≤‡∏´‡∏≠
                    <span class="inline-block w-3 h-3 bg-yellow-400 rounded-full mr-1 ml-2"></span>‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà
                    <span class="inline-block w-3 h-3 bg-gray-400 rounded-full mr-1 ml-2"></span>‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                </div>`;

                Swal.fire({
                    title: '<span class="text-xl font-bold text-gray-700">üìä ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Stacked)</span>',
                    html: htmlContent,
                    width: '650px',
                    showCloseButton: true,
                    focusConfirm: false,
                    confirmButtonText: '‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á',
                    confirmButtonColor: '#6B7280',
                    customClass: {
                        container: 'font-sarabun',
                        popup: 'rounded-2xl'
                    },
                    didOpen: () => {
                        const ctx = document.getElementById('budgetChart').getContext('2d');
                        const fullLabels = universities.map(u => u.name);

                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏° (‡∏õ‡∏µ)',
                                        data: tuitionData,
                                        backgroundColor: '#F87171', // Red 400
                                        stack: 'Stack 0'
                                    },
                                    {
                                        label: '‡∏Ñ‡πà‡∏≤‡∏´‡∏≠‡∏û‡∏±‡∏Å (‡∏õ‡∏µ)',
                                        data: dormData,
                                        backgroundColor: '#60A5FA', // Blue 400
                                        stack: 'Stack 0'
                                    },
                                    {
                                        label: '‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà (‡∏õ‡∏µ)',
                                        data: livingData,
                                        backgroundColor: '#FACC15', // Yellow 400
                                        stack: 'Stack 0'
                                    },
                                    {
                                        label: '‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£',
                                        data: appData,
                                        backgroundColor: '#9CA3AF', // Gray 400
                                        stack: 'Stack 0'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            title: function (context) {
                                                const idx = context[0].dataIndex;
                                                return fullLabels[idx];
                                            },
                                            label: function (context) {
                                                return context.dataset.label + ': ' + parseInt(context.raw).toLocaleString() + ' ‡∏ö.';
                                            },
                                            afterBody: function (context) {
                                                const idx = context[0].dataIndex;
                                                const total = tuitionData[idx] + dormData[idx] + livingData[idx] + appData[idx];
                                                return '----------------\n‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ' + total.toLocaleString() + ' ‡∏ö.';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: { stacked: true },
                                    y: {
                                        stacked: true,
                                        ticks: {
                                            callback: function (value) { return '‡∏ø' + (value / 1000) + 'k'; },
                                            font: { size: 10 }
                                        }
                                    }
                                }
                            }
                        });
                    }
                });
            }

            init();
        </script>
</body>

</html>