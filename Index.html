<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Tracker + AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c084fc;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a855f7;
        }

        .dashed-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='8' ry='8' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s ease;
        }

        .dashed-box:hover {
            background-color: #F8FAFC;
            border-color: #94A3B8;
        }

        .swal2-popup {
            font-family: 'Sarabun', sans-serif;
            border-radius: 15px;
        }

        /* --- New Typography Styles for AI Output --- */
        .prose-custom h1,
        .prose-custom h2,
        .prose-custom h3 {
            color: #4338ca;
            /* Indigo-700 */
            font-weight: 700;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
        }

        .prose-custom h3 {
            font-size: 1.1em;
            border-left: 4px solid #facc15;
            padding-left: 8px;
        }

        .prose-custom p {
            margin-bottom: 1em;
            line-height: 1.7;
            color: #374151;
        }

        .prose-custom ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose-custom ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose-custom li {
            margin-bottom: 0.5em;
        }

        .prose-custom strong {
            color: #7e22ce;
            font-weight: 700;
        }

        /* Purple emphasis */
        .prose-custom blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 1em;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-2 md:p-6">

    <!-- Navbar -->
    <div
        class="max-w-7xl mx-auto bg-blue-600 text-white p-4 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-white/20 p-2 rounded-full"><i class="fas fa-user-graduate text-2xl"></i></div>
            <div>
                <h1 class="text-xl md:text-2xl font-bold">Admission Tracker</h1>
                <p class="text-blue-100 text-sm">GPAX: <span id="displayGpax"
                        class="font-bold text-yellow-300">-.-</span></p>
            </div>
        </div>
        <div class="mt-3 md:mt-0 text-right flex flex-col items-end">
            <div class="flex items-center gap-2 bg-blue-700 px-3 py-1 rounded-lg">
                <i class="fas fa-bullseye text-yellow-400"></i>
                <span class="text-sm font-semibold">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <span id="headerTargetCount">5</span> ‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢</span>
                <span id="uniCountBadge"
                    class="bg-white text-blue-700 text-xs font-bold px-2 py-0.5 rounded-full ml-1">0/5</span>
            </div>
            <div class="flex gap-2 mt-2">
                <button onclick="openBudgetPlanner()"
                    class="bg-white/10 hover:bg-white/20 border border-white/20 text-white text-sm font-medium px-4 py-1.5 rounded-lg transition flex items-center gap-2 shadow-sm backdrop-blur-sm group">
                    <i class="fas fa-coins text-yellow-300 group-hover:scale-110 transition"></i> ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
                </button>
                <button onclick="openSettings()"
                    class="bg-black/20 hover:bg-black/30 border border-transparent text-blue-100 text-sm font-medium px-4 py-1.5 rounded-lg transition flex items-center gap-2 shadow-sm">
                    <i class="fas fa-cog group-hover:rotate-90 transition"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 items-start h-full">

        <!-- ================= LEFT COLUMN: AI ASSISTANT ================= -->
        <div
            class="bg-white rounded-xl shadow-md border border-purple-100 overflow-hidden flex flex-col h-full lg:sticky lg:top-4">
            <div
                class="bg-gradient-to-r from-purple-100 to-indigo-50 p-4 border-b border-purple-200 flex items-center gap-2">
                <i class="fas fa-robot text-purple-600 text-xl"></i>
                <div>
                    <h2 class="font-bold text-purple-800">AI Assistant</h2>
                    <p class="text-xs text-purple-600">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å & ‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
                </div>
            </div>

            <div class="p-4 space-y-6 flex-grow overflow-y-auto custom-scrollbar"
                style="max-height: calc(100vh - 150px);">

                <!-- Feature 1: Question Generator -->
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-100 shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm flex items-center">
                        <i class="fas fa-comment-dots text-purple-500 mr-2"></i>1. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠?
                    </h3>

                    <textarea id="situationInput" rows="2"
                        class="w-full p-3 border border-purple-200 rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-400 shadow-sm"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÅ‡∏ï‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏π..."></textarea>

                    <!-- Quick Chips -->
                    <div class="flex flex-wrap gap-2 mt-2 mb-3">
                        <button onclick="setSituation('‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° ‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡∏û‡∏≠‡∏£‡πå‡∏ï')"
                            class="text-xs bg-white border border-purple-200 text-purple-600 px-2 py-1 rounded-full hover:bg-purple-100 transition shadow-sm">üéÆ
                            ‡∏ï‡∏¥‡∏î‡πÄ‡∏Å‡∏°</button>
                        <button onclick="setSituation('‡∏ô‡πâ‡∏≠‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á')"
                            class="text-xs bg-white border border-purple-200 text-purple-600 px-2 py-1 rounded-full hover:bg-purple-100 transition shadow-sm">üìÖ
                            ‡∏≠‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</button>
                        <button onclick="setSituation('‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö')"
                            class="text-xs bg-white border border-purple-200 text-purple-600 px-2 py-1 rounded-full hover:bg-purple-100 transition shadow-sm">ü§ê
                            ‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö</button>
                        <button onclick="setSituation('‡∏ô‡πâ‡∏≠‡∏á‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏π')"
                            class="text-xs bg-white border border-purple-200 text-purple-600 px-2 py-1 rounded-full hover:bg-purple-100 transition shadow-sm">üîí
                            ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡∏≤‡∏ô</button>
                    </div>

                    <button onclick="generateQuestion()"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2.5 px-4 rounded-lg transition text-sm flex justify-center items-center shadow-md">
                        <i class="fas fa-wand-magic-sparkles mr-2"></i> ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button>
                </div>

                <!-- Feature 2: Excuse Buster -->
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm flex items-center">
                        <i class="fas fa-search-plus text-indigo-500 mr-2"></i>2. ‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°? (‡∏à‡∏±‡∏ö‡πÄ‡∏ó‡πá‡∏à)
                    </h3>
                    <textarea id="siblingQuote" rows="2"
                        class="w-full p-3 border border-indigo-200 rounded-lg bg-white text-sm mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-sm"
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î‡∏°‡∏≤... ‡πÄ‡∏ä‡πà‡∏ô '‡πÄ‡∏ß‡πá‡∏ö‡∏•‡πà‡∏° ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'"></textarea>
                    <button onclick="analyzeQuote()"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg transition text-sm flex justify-center items-center shadow-md">
                        <i class="fas fa-microscope mr-2"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å
                    </button>
                </div>

                <!-- AI Output Area -->
                <div id="aiResultContainer" class="hidden animate-fade-in-up">
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                        <div
                            class="bg-gray-100 px-4 py-3 flex justify-between items-center border-b text-sm font-bold text-gray-700">
                            <span><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI</span>
                            <button onclick="closeResult()" class="text-gray-400 hover:text-red-500 transition"><i
                                    class="fas fa-times fa-lg"></i></button>
                        </div>
                        <div id="aiOutputContent" class="p-5 prose-custom text-sm"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- ================= RIGHT COLUMN: UNIVERSITY DATA ================= -->
        <div class="space-y-4">
            <div class="flex justify-between items-end">
                <h2 class="text-xl font-bold text-gray-800"><i
                        class="fas fa-list-ul mr-2 text-blue-600"></i>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</h2>
            </div>
            <div id="universityList" class="space-y-4">
                <!-- Javascript will populate this -->
            </div>
        </div>

    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center items-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-fade-in-up">
            <div class="bg-gray-100 px-4 py-3 border-b flex justify-between items-center">
                <h3 class="font-bold text-gray-700"><i class="fas fa-cog text-gray-500 mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-red-500"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-6">

                <!-- API Key Section -->
                <!-- General Settings Section -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß & API</label>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-500">GPAX (‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</label>
                            <input type="number" step="0.01" id="gpaxInput" placeholder="0.00"
                                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏µ‡πà‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢?</label>
                            <input type="number" id="targetCountInput" value="5" min="1" max="20"
                                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Gemini API Key</label>
                            <input type="password" id="apiKeyInput" placeholder="‡∏ß‡∏≤‡∏á API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <button onclick="saveSettings()"
                            class="w-full bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                    </div>
                </div>

                <hr>

                <!-- Data Management Section -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup/Restore)</label>
                    <div class="flex gap-2">
                        <button onclick="exportData()"
                            class="flex-1 bg-green-50 text-green-700 border border-green-200 hover:bg-green-100 px-4 py-2 rounded text-sm font-semibold">
                            <i class="fas fa-download mr-1"></i> ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Export)
                        </button>
                        <button onclick="document.getElementById('importFile').click()"
                            class="flex-1 bg-orange-50 text-orange-700 border border-orange-200 hover:bg-orange-100 px-4 py-2 rounded text-sm font-semibold">
                            <i class="fas fa-upload mr-1"></i> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô (Import)
                        </button>
                        <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                    </div>
                </div>

                <hr>

                <!-- Reset Section -->
                <div>
                    <button onclick="resetData()"
                        class="w-full text-red-500 text-sm hover:bg-red-50 p-2 rounded transition">
                        ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reset Factory)
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Javascript Logic -->
    <script>
        // --- DATA MANAGEMENT (Same as before) ---
        const defaultUniversities = [
            { id: 1, name: "‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á", faculty: "‡∏Ñ‡∏ì‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á", targetDate: "2025-12-31", officialDate: "2026-01-01", status: "Not Started" }
        ];

        let universities = [];
        let geminiApiKey = "";
        let userGpax = "-.-";
        let targetUniCount = 5;

        function init() {
            // Load Data
            const savedData = localStorage.getItem('admission_tracker_data');
            if (savedData) {
                universities = JSON.parse(savedData);
            } else {
                universities = [...defaultUniversities];
            }

            // Load API Key
            geminiApiKey = localStorage.getItem('gemini_api_key') || "";
            if (geminiApiKey) {
                document.getElementById('apiKeyInput').value = geminiApiKey;
            }

            // Load GPAX
            userGpax = localStorage.getItem('admission_tracker_gpax') || "-.-";
            document.getElementById('displayGpax').innerText = userGpax;
            document.getElementById('gpaxInput').value = userGpax === "-.-" ? "" : userGpax;

            // Load Target Count
            const savedTarget = localStorage.getItem('admission_target_count');
            targetUniCount = savedTarget ? parseInt(savedTarget) : 5;
            document.getElementById('targetCountInput').value = targetUniCount;

            renderUniversities();
            setTimeout(showWelcomeModal, 800);
        }

        function saveToLocal() {
            localStorage.setItem('admission_tracker_data', JSON.stringify(universities));
            renderUniversities();
        }

        // --- SETTINGS & DATA MANAGEMENT ---
        function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }

        function saveSettings() {
            // Save API Key
            const key = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('gemini_api_key', key);
            geminiApiKey = key;

            // Save GPAX
            const gpax = document.getElementById('gpaxInput').value.trim();
            userGpax = gpax || "-.-";
            localStorage.setItem('admission_tracker_gpax', userGpax);
            document.getElementById('displayGpax').innerText = userGpax;

            // Save Target Count
            const targetVal = document.getElementById('targetCountInput').value;
            targetUniCount = targetVal ? parseInt(targetVal) : 5;
            localStorage.setItem('admission_target_count', targetUniCount);
            renderUniversities();

            Swal.fire('Success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
        }

        function exportData() {
            // Bundle data + API Key + GPAX + Target
            const exportObj = {
                universities: universities,
                apiKey: geminiApiKey || "",
                gpax: userGpax,
                targetCount: targetUniCount
            };

            const dataStr = JSON.stringify(exportObj, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admission_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            Swal.fire('Downloaded', '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Backup (‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Support old format (array only) and new format (object with apiKey)
                    if (Array.isArray(data)) {
                        // Old format: just universities
                        universities = data;
                        saveToLocal();
                        Swal.fire('Success', '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡πÑ‡∏°‡πà‡∏û‡∏ö API Key ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå)', 'success');
                    } else if (data.universities && Array.isArray(data.universities)) {
                        // New format: universities + apiKey + gpax + targetCount
                        universities = data.universities;
                        saveToLocal();

                        // Restore API Key
                        if (data.apiKey) {
                            localStorage.setItem('gemini_api_key', data.apiKey);
                            geminiApiKey = data.apiKey;
                            document.getElementById('apiKeyInput').value = geminiApiKey;
                        }

                        // Restore GPAX
                        if (data.gpax) {
                            localStorage.setItem('admission_tracker_gpax', data.gpax);
                            userGpax = data.gpax;
                            document.getElementById('displayGpax').innerText = userGpax;
                            document.getElementById('gpaxInput').value = userGpax === "-.-" ? "" : userGpax;
                        }

                        // Restore Target Count
                        if (data.targetCount) {
                            localStorage.setItem('admission_target_count', data.targetCount);
                            targetUniCount = data.targetCount;
                            document.getElementById('targetCountInput').value = targetUniCount;
                        }

                        Swal.fire('Success', '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!', 'success');
                    } else {
                        throw new Error('Invalid format');
                    }
                    closeSettings();
                } catch (err) {
                    console.error(err);
                    Swal.fire('Error', '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }

        function resetData() {
            Swal.fire({
                title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
                text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('admission_tracker_data');
                    localStorage.removeItem('gemini_api_key');
                    location.reload();
                }
            })
        }

        function getDaysLeft(dateStr) {
            if (!dateStr) return null;
            const target = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            target.setHours(0, 0, 0, 0);
            return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
        }

        function formatDate(dateStr) {
            if (!dateStr) return "-";
            return new Date(dateStr).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }

        function renderUniversities() {
            const list = document.getElementById('universityList');
            const countBadge = document.getElementById('uniCountBadge');
            list.innerHTML = '';

            const filledCount = universities.length;
            document.getElementById('headerTargetCount').innerText = targetUniCount;
            countBadge.innerText = `${filledCount}/${targetUniCount}`;
            countBadge.className = filledCount >= targetUniCount ? "bg-green-500 text-white text-xs font-bold px-2 py-0.5 rounded-full ml-1" : "bg-white text-blue-700 text-xs font-bold px-2 py-0.5 rounded-full ml-1";

            universities.forEach((uni, index) => {
                // Target Date Logic
                const daysLeft = getDaysLeft(uni.targetDate);
                let daysText = "", daysClass = "";

                if (daysLeft === null) { daysText = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô"; daysClass = "text-gray-400"; }
                else if (daysLeft < 0) { daysText = `‡πÄ‡∏•‡∏¢‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${Math.abs(daysLeft)} ‡∏ß‡∏±‡∏ô`; daysClass = "text-red-600 font-bold"; }
                else if (daysLeft === 0) { daysText = "‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!"; daysClass = "text-red-600 font-bold animate-pulse"; }
                else { daysText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${daysLeft} ‡∏ß‡∏±‡∏ô`; daysClass = daysLeft <= 5 ? "text-red-500 font-bold" : "text-green-600 font-bold"; }

                // Official Deadline Logic (New)
                const offDaysLeft = getDaysLeft(uni.officialDate);
                let offDaysText = "", offDaysClass = "";

                if (offDaysLeft === null) { offDaysText = "‡∏¢‡∏±‡∏á‡∏°‡∏∂‡∏ô‡πÜ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)"; offDaysClass = "text-red-300"; }
                else if (offDaysLeft < 0) { offDaysText = `‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß (${Math.abs(offDaysLeft)} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß)`; offDaysClass = "text-gray-400 font-bold"; }
                else if (offDaysLeft === 0) { offDaysText = "‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢!"; offDaysClass = "text-red-700 font-extrabold animate-pulse"; }
                else { offDaysText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${offDaysLeft} ‡∏ß‡∏±‡∏ô`; offDaysClass = offDaysLeft <= 7 ? "text-red-600 font-bold" : "text-red-400 font-medium"; }


                const isStarted = uni.status === "In Progress" || uni.status === "Done";
                const borderClass = isStarted ? "border-l-4 border-yellow-400" : "border border-gray-200 opacity-90";

                const html = `
                <div class="bg-white p-4 rounded-xl shadow-sm ${borderClass} relative group hover:shadow-md transition">
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
                                <h3 class="font-bold text-lg text-gray-800 break-words line-clamp-2">${index + 1}. ${uni.name}</h3>
                                <span class="text-[10px] px-2 py-0.5 rounded-full whitespace-nowrap ${getStatusColor(uni.status)}">${uni.status}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2 truncate">${uni.faculty || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ì‡∏∞"}</p>
                            
                            <!-- Financial & Notes -->
                            <div class="flex flex-wrap gap-2 text-[10px] mt-2 border-t pt-2 border-gray-100">
                                ${uni.appFee ? `<span class="bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100"><i class="fas fa-tag mr-1"></i>‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${parseInt(uni.appFee).toLocaleString()}</span>` : ''}
                                ${uni.tuitionFee ? `<span class="bg-orange-50 text-orange-700 px-2 py-1 rounded border border-orange-100"><i class="fas fa-university mr-1"></i>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏°: ${parseInt(uni.tuitionFee).toLocaleString()}</span>` : ''}
                            </div>
                            ${uni.remark ? `<p class="text-xs text-gray-400 italic mt-1 bg-gray-50 p-1.5 rounded border border-gray-100 line-clamp-1"><i class="fas fa-sticky-note mr-1"></i>${uni.remark}</p>` : ''}
                        </div>
                        <button onclick="openEditModal(${index})" class="flex-shrink-0 text-gray-400 hover:text-blue-600 transition p-2 bg-gray-50 rounded-lg hover:bg-blue-50"><i class="fas fa-edit"></i></button>
                    </div>
                    <div class="flex gap-3 mt-3">
                        <div class="flex-1 bg-gradient-to-br from-blue-50 to-blue-100/50 p-2 rounded-lg border border-blue-100 text-center cursor-pointer hover:border-blue-300 transition" onclick="openEditModal(${index})">
                            <p class="text-[10px] uppercase text-blue-500 font-bold tracking-wide">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏á</p>
                            <p class="text-lg font-bold text-blue-700 leading-tight mt-1">${formatDate(uni.targetDate)}</p>
                            <p class="text-[10px] mt-1 ${daysClass}">${daysText}</p>
                        </div>
                        <div class="flex-1 bg-gradient-to-br from-red-50 to-red-100/50 p-2 rounded-lg border border-red-100 text-center cursor-pointer hover:border-red-300 transition group/official" onclick="openEditModal(${index})">
                            <p class="text-[10px] uppercase text-red-500 font-bold tracking-wide group-hover/official:text-red-700">Official Deadline</p>
                            <p class="text-lg font-bold text-red-700 leading-tight mt-1">${formatDate(uni.officialDate)}</p>
                            <p class="text-[10px] mt-1 ${offDaysClass}">${offDaysText}</p>
                        </div>
                    </div>
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
            });

            for (let i = universities.length; i < targetUniCount; i++) {
                const html = `
                <div onclick="openAddModal()" class="dashed-box p-4 rounded-xl flex flex-col items-center justify-center text-center h-32 cursor-pointer group">
                    <div class="bg-white p-3 rounded-full shadow-sm mb-2 group-hover:scale-110 transition group-hover:bg-blue-50"><i class="fas fa-plus text-gray-400 text-xl group-hover:text-blue-500"></i></div>
                    <h4 class="text-gray-500 font-bold text-sm group-hover:text-blue-600">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${i + 1}</h4>
                    <p class="text-xs text-red-400 font-light">‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á! (‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á)</p>
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
            }
        }

        function getStatusColor(status) {
            if (status === 'In Progress') return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
            if (status === 'Done') return 'bg-green-100 text-green-800 border border-green-200';
            return 'bg-gray-200 text-gray-600';
        }

        async function openEditModal(index) {
            const uni = universities[index];
            const { value: formValues } = await Swal.fire({
                title: `<span class="text-2xl font-bold text-gray-700">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢</span>`,
                html: generateModalHtml(uni),
                width: '600px',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                confirmButtonColor: '#2563EB',
                cancelButtonText: '<i class="fas fa-trash-alt mr-1"></i> ‡∏•‡∏ö‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏µ‡πâ',
                cancelButtonColor: '#EF4444',
                focusConfirm: false,
                customClass: {
                    popup: 'rounded-2xl',
                    container: 'font-sarabun'
                },
                preConfirm: () => getModalValues()
            });

            if (formValues) { universities[index] = { ...universities[index], ...formValues }; saveToLocal(); }
            else if (Swal.getDismissReason() === Swal.DismissReason.cancel) { if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏µ‡πâ?')) { universities.splice(index, 1); saveToLocal(); } }
        }

        async function openAddModal() {
            const { value: formValues } = await Swal.fire({
                title: `<span class="text-2xl font-bold text-gray-700">‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡πÉ‡∏´‡∏°‡πà</span>`,
                html: generateModalHtml({}), // Pass empty object for defaults
                width: '600px',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-plus mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
                confirmButtonColor: '#10B981',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                focusConfirm: false,
                customClass: {
                    popup: 'rounded-2xl',
                    container: 'font-sarabun'
                },
                preConfirm: () => getModalValues()
            });
            if (formValues) { universities.push({ id: Date.now(), ...formValues }); saveToLocal(); }
        }

        function generateModalHtml(data) {
            // Helper to safe string
            const val = (key) => data[key] || '';

            return `
            <div class="text-left space-y-5 px-1 py-2">
                
                <!-- Section 1: Identity -->
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1"><i class="fas fa-university text-blue-500 mr-2"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</label>
                        <input id="swal-name" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition outline-none shadow-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏á‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢" value="${val('name')}">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1"><i class="fas fa-graduation-cap text-purple-500 mr-2"></i>‡∏Ñ‡∏ì‡∏∞/‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <input id="swal-faculty" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:bg-white transition outline-none shadow-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå" value="${val('faculty')}">
                    </div>
                </div>

                <!-- Section 2: Timeline -->
                <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fas fa-calendar-alt text-4xl text-blue-500"></i></div>
                    <label class="block text-xs font-bold text-blue-800 mb-3 uppercase tracking-wide border-b border-blue-100 pb-1">üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£ (Timeline)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[11px] text-gray-500 block mb-1 font-semibold">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</label>
                            <input type="date" id="swal-target" class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:border-blue-500 outline-none shadow-sm bg-white" value="${val('targetDate')}">
                        </div>
                        <div>
                            <label class="text-[11px] text-red-500 block mb-1 font-bold">Official Deadline</label>
                            <input type="date" id="swal-official" class="w-full p-2 border border-red-200 rounded-lg text-sm focus:border-red-500 outline-none shadow-sm bg-white" value="${val('officialDate')}">
                        </div>
                    </div>
                </div>

                <!-- Section 3: Financials -->
                <div class="bg-green-50/50 p-4 rounded-xl border border-green-100 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fas fa-coins text-4xl text-green-500"></i></div>
                    <label class="block text-xs font-bold text-green-800 mb-3 uppercase tracking-wide border-b border-green-100 pb-1">üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                         <div>
                            <label class="block text-[10px] text-gray-500 mb-1">‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≠‡∏ö (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-400 text-xs">‡∏ø</span>
                                <input type="number" id="swal-appFee" class="w-full pl-6 p-2 border border-gray-200 rounded text-sm focus:border-green-500 outline-none bg-white" value="${val('appFee')}" placeholder="0">
                            </div>
                         </div>
                         <div>
                            <label class="block text-[10px] text-gray-500 mb-1">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏° (‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡∏≠‡∏°)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-400 text-xs">‡∏ø</span>
                                <input type="number" id="swal-tuitionFee" class="w-full pl-6 p-2 border border-gray-200 rounded text-sm focus:border-green-500 outline-none bg-white" value="${val('tuitionFee')}" placeholder="0">
                            </div>
                         </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                         <div>
                            <label class="block text-[10px] text-gray-500 mb-1">‡∏Ñ‡πà‡∏≤‡∏´‡∏≠‡∏û‡∏±‡∏Å (‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-400 text-xs">‡∏ø</span>
                                <input type="number" id="swal-dormFee" class="w-full pl-6 p-2 border border-gray-200 rounded text-sm focus:border-green-500 outline-none bg-white" value="${val('dormFee')}" placeholder="0">
                            </div>
                         </div>
                         <div>
                            <label class="block text-[10px] text-gray-500 mb-1">‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà (‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-400 text-xs">‡∏ø</span>
                                <input type="number" id="swal-livingCost" class="w-full pl-6 p-2 border border-gray-200 rounded text-sm focus:border-green-500 outline-none bg-white" value="${val('livingCost')}" placeholder="0">
                            </div>
                         </div>
                    </div>
                </div>

                <!-- Section 4: Status & Remark -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select id="swal-status" class="w-full p-2.5 border border-gray-300 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-gray-200">
                            <option value="Not Started" ${val('status') === 'Not Started' ? 'selected' : ''}>‚ö™ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</option>
                            <option value="In Progress" ${val('status') === 'In Progress' ? 'selected' : ''}>üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                            <option value="Done" ${val('status') === 'Done' ? 'selected' : ''}>üü¢ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Memo (‡∏Ç‡πâ‡∏≠‡∏î‡∏µ/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢)</label>
                        <textarea id="swal-remark" rows="3" class="w-full p-2.5 border border-gray-300 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-gray-200 transition resize-y" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡πÅ‡∏ï‡πà‡∏Ñ‡πà‡∏≤‡∏´‡∏≠‡πÅ‡∏û‡∏á...">${val('remark')}</textarea>
                    </div>
                </div>
            </div>`;
        }

        function getModalValues() {
            return {
                name: document.getElementById('swal-name').value,
                faculty: document.getElementById('swal-faculty').value,
                targetDate: document.getElementById('swal-target').value,
                officialDate: document.getElementById('swal-official').value,
                status: document.getElementById('swal-status').value,
                appFee: document.getElementById('swal-appFee').value,
                tuitionFee: document.getElementById('swal-tuitionFee').value,
                dormFee: document.getElementById('swal-dormFee').value,
                livingCost: document.getElementById('swal-livingCost').value,
                remark: document.getElementById('swal-remark').value
            };
        }

        // --- AI LOGIC (Enhanced Prompts) ---
        function setSituation(text) { document.getElementById('situationInput').value = text; }

        async function callGemini(prompt) {
            if (!geminiApiKey) {
                Swal.fire('API Key Missing', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI', 'warning');
                return "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
            }
            const apiKey = geminiApiKey;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) { console.error(error); return "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"; }
        }

        function showResult(html) {
            const container = document.getElementById('aiResultContainer');
            document.getElementById('aiOutputContent').innerHTML = html;
            container.classList.remove('hidden');
        }
        function closeResult() { document.getElementById('aiResultContainer').classList.add('hidden'); }
        function setLoading(btn) {
            document.getElementById('aiResultContainer').classList.remove('hidden');
            document.getElementById('aiOutputContent').innerHTML = '<div class="text-center py-8 text-purple-600"><i class="fas fa-spinner fa-spin fa-2x mb-3"></i><br>AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å...</div>';
            btn.disabled = true; btn.classList.add('opacity-50');
        }
        function clearLoading(btn) { btn.disabled = false; btn.classList.remove('opacity-50'); }

        async function generateQuestion() {
            const situation = document.getElementById('situationInput').value;
            if (!situation.trim()) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
            const btn = document.querySelector('button[onclick="generateQuestion()"]');
            setLoading(btn);

            const prompt = `
                Role: ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß (Family Counselor)
                Task: ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏û‡∏µ‡πà‡∏™‡∏≤‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≠‡∏á (‡∏°.6, TCAS69)
                Situation: "${situation}"
                
                Instruction: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÇ‡∏î‡∏¢‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
                1. üß† **‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ô‡πâ‡∏≠‡∏á:** ‡∏ó‡∏≥‡πÑ‡∏°‡∏ô‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ? (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏•‡∏±‡∏ß‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß, ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏™‡∏∞‡∏™‡∏°, ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≠‡∏≠‡πâ‡∏≤‡∏á) ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô
                2. üó£Ô∏è **‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ (Scripts):**
                   - üç¨ **‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡∏°‡∏∏‡∏ô (Soft Approach):** ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à
                   - üî• **‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô (Nudge Approach):** ‡∏ä‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏î‡∏∏‡∏î‡πà‡∏≤
                   - üõ°Ô∏è **‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î (Firm Boundary):** ‡∏ñ‡πâ‡∏≤ 2 ‡πÅ‡∏ö‡∏ö‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏• ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≤‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£
                3. üí° **‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:** ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
                
                Format: HTML (‡πÉ‡∏ä‡πâ <h3>, <ul>, <li>, <strong>, <p> ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢)
            `;
            const result = await callGemini(prompt);
            showResult(marked.parse(result));
            clearLoading(btn);
        }

        async function analyzeQuote() {
            const quote = document.getElementById('siblingQuote').value;
            if (!quote.trim()) return Swal.fire('‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
            const btn = document.querySelector('button[onclick="analyzeQuote()"]');
            setLoading(btn);

            const prompt = `
                Role: ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏£‡∏∞‡∏ö‡∏ö TCAS ‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡∏à‡∏±‡∏ö‡πÇ‡∏Å‡∏´‡∏Å (Fact Checker)
                Task: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏á: "${quote}"
                
                Instruction: ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:
                1. üîç **‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠ (Verdict):** (‡∏™‡∏π‡∏á/‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡∏ï‡πà‡∏≥) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
                2. üßê **‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:** ‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô? ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏≠‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                3. üïµÔ∏è **‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Investigate):** ‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà "‡∏î‡∏¥‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏∏‡∏î" (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏´‡∏ô, ‡∏Ç‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏´‡∏ô)
                4. üé≠ **‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà:** ‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡πÇ‡∏Å‡∏´‡∏Å ‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£?
                
                Format: HTML (‡πÉ‡∏ä‡πâ <h3>, <ul>, <li>, <strong>, <p> ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢)
            `;
            const result = await callGemini(prompt);
            showResult(marked.parse(result));
            clearLoading(btn);
        }

        async function quickSetApiKey() {
            Swal.close();
            const { value: key } = await Swal.fire({
                title: '‡πÉ‡∏™‡πà Gemini API Key',
                input: 'text',
                inputAttributes: {
                    autocapitalize: 'off'
                },
                inputPlaceholder: 'Paste your API Key here...',
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                confirmButtonColor: '#7c3aed',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (key) {
                localStorage.setItem('gemini_api_key', key.trim());
                geminiApiKey = key.trim();
                document.getElementById('apiKeyInput').value = geminiApiKey; // Sync with settings
                Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Key ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                    text: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI Assistant ‡πÅ‡∏•‡πâ‡∏ß!',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        }

        function showWelcomeModal() {
            if (sessionStorage.getItem('intro_seen')) return;

            Swal.fire({
                title: 'üêª ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö!',
                html: `
                    <div class="text-left text-sm space-y-4">
                        <div class="bg-blue-50 p-3 rounded border border-blue-100 text-blue-800">
                             <i class="fas fa-info-circle mr-1"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="document.getElementById('importFile').click(); Swal.close();" 
                                class="text-left w-full bg-white hover:bg-orange-50 text-gray-700 hover:text-orange-700 p-3 rounded border border-gray-200 hover:border-orange-200 transition flex items-center shadow-sm group">
                                <span class="bg-orange-100 text-orange-600 p-2.5 rounded-full mr-3 group-hover:scale-110 transition"><i class="fas fa-file-import"></i></span>
                                <div>
                                    <div class="font-bold">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (Restore)</div>
                                    <div class="text-xs text-gray-500 group-hover:text-orange-600">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠ Restoe ‡πÑ‡∏ü‡∏•‡πå Backup ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤</div>
                                </div>
                            </button>
                            
                            <button onclick="quickSetApiKey()" 
                                class="text-left w-full bg-white hover:bg-purple-50 text-gray-700 hover:text-purple-700 p-3 rounded border border-gray-200 hover:border-purple-200 transition flex items-center shadow-sm group">
                                <span class="bg-purple-100 text-purple-600 p-2.5 rounded-full mr-3 group-hover:scale-110 transition"><i class="fas fa-key"></i></span>
                                <div>
                                    <div class="font-bold">‡πÉ‡∏™‡πà API Key (AI)</div>
                                    <div class="text-xs text-gray-500 group-hover:text-purple-600">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
                                </div>
                            </button>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t text-xs text-center text-gray-400">
                            <p class="mb-2"><i class="fas fa-exclamation-triangle"></i> ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô Cloud</p>
                            <p><b>‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏° Backup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</b> ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
                        </div>

                        <div class="mt-2 text-center">
                             <button onclick="Swal.close()" class="text-gray-400 text-xs hover:text-gray-600 font-semibold underline">
                                ‚úï ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠)
                             </button>
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                allowOutsideClick: false,
                padding: '2rem',
                width: '420px',
                background: '#fff',
                backdrop: `
                    rgba(0,0,123,0.4)
                    left top
                    no-repeat
                `
            }).then(() => {
                sessionStorage.setItem('intro_seen', 'true');
            });
        }

        // --- EXIT WARNING ---
        window.addEventListener('beforeunload', function (e) {
            e.preventDefault();
            e.returnValue = ''; // Trigger browser warning
        });

        // --- BUDGET PLANNER ---
        function openBudgetPlanner() {
            if (universities.length === 0) return Swal.fire('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Budget Planner', 'info');

            let htmlContent = `<div class="space-y-4">`;

            universities.forEach((uni, index) => {
                const tuition = parseInt(uni.tuitionFee || 0);
                const dorm = parseInt(uni.dormFee || 0);
                const living = parseInt(uni.livingCost || 0);
                const app = parseInt(uni.appFee || 0);

                // Calculation: 1 Year (2 Terms, 12 Months)
                const yearlyTuition = tuition * 2;
                const yearlyFixed = (dorm + living) * 12;
                const firstYearTotal = yearlyTuition + yearlyFixed + app;

                htmlContent += `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-start mb-2">
                         <h3 class="font-bold text-blue-900 text-left truncate w-3/4"><span class="text-gray-400 mr-1">#${index + 1}</span> ${uni.name}</h3>
                         <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold whitespace-nowrap">‡∏õ‡∏µ‡∏•‡∏∞ ‚âà ${firstYearTotal.toLocaleString()} ‡∏ö.</span>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-left">
                        <div class="bg-white p-2 rounded border">
                            <div class="text-gray-500">‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>
                            <div class="font-bold text-gray-800">${app > 0 ? app.toLocaleString() : '-'}</div>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <div class="text-gray-500 text-[10px]">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏° (X2)</div>
                            <div class="font-bold text-gray-800">${tuition > 0 ? tuition.toLocaleString() : '-'}</div>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <div class="text-gray-500 text-[10px]">‡∏´‡∏≠‡∏û‡∏±‡∏Å (X12)</div>
                            <div class="font-bold text-gray-800">${dorm > 0 ? dorm.toLocaleString() : '-'}</div>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <div class="text-gray-500 text-[10px]">‡∏Å‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà (X12)</div>
                            <div class="font-bold text-gray-800">${living > 0 ? living.toLocaleString() : '-'}</div>
                        </div>
                    </div>

                    ${(tuition + dorm + living) === 0 ? '<p class="text-[10px] text-red-400 mt-2 text-left">*‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</p>' : ''}
                </div>`;
            });

            htmlContent += `
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs text-left text-yellow-800">
                    <i class="fas fa-lightbulb mr-1"></i> <b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£ 1 ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤):</b><br>
                    (‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏° x 2) + (‡∏Ñ‡πà‡∏≤‡∏´‡∏≠‡∏û‡∏±‡∏Å x 12) + (‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà x 12) + ‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                </div>
            </div>`;

            Swal.fire({
                title: '<span class="text-xl">üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</span>',
                html: htmlContent,
                width: '600px',
                showCloseButton: true,
                focusConfirm: false,
                confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö (OK)',
                confirmButtonColor: '#10B981',
                customClass: {
                    container: 'font-sarabun'
                }
            });
        }

        init();
    </script>
</body>

</html>